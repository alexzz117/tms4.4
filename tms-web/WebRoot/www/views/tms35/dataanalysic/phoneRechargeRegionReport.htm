<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>手机充值地域视图</title>
    <!-- 引入 echarts.js -->
	<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
	<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
	<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
	<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script> 
	<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
	<script type="text/javascript" src="$rc.contextPath/s/tms35/js/commoncheck.js"></script>
	<script type="text/javascript" src="$rc.contextPath/s/tms35/js/stat.js"></script>
	<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.url.js"></script>
	<script type="text/javascript" src="$rc.contextPath/s/report/echarts/echarts.min.js"></script>
	<script type="text/javascript" src="$rc.contextPath/s/report/echarts/china.js"></script>
	<style type="text/css">
.chartsDiv{
	height:600px;
	width:98%;
	border:0.5px solid;
}
</style>
	 <script type="text/javascript">
    var g = "";
    $(document).ready(function(){
    	chartBox = new jcl.ui.Box({
    		title:'手机充值地域视图'
    	});
    	chartBox.title.css({cursor: 'pointer'});
    	chartBox.container.parent().parent().css({borderBottomWidth:0});
    	displayBoxContent(chartBox.title, chartBox.container);
    	
    	//快速查询表单
    	charForm = new jcl.ui.Form({
    		display: true,
    		layout: 'list',
    		items:[
    			{label:'客户号',name:'ACCOUNTNO',  type:'text'},
    			{label: '交易时间', name: 'TXNTIME',type: 'dateduration', duraSeparator:' 到  ', layout:'datetime',items:[{name:'startTime'},{name:'endTime'}]}
    		],
    		btns:[
    			{id: 'chart_search_btn', text: '#springMessage("view.cmc.but.find")'}
    		]
    	}, chartBox.container);
    	
    	chartBox.addDom($('#chartdiv'));
    	$("#chart_search_btn").click(function(){
			showChart();
		});
    	
    	showMap();
    }); 
       
   
    function showChart(){
    	var charParam = charForm.serialize();//查询框中的信息
    	var accountno = charForm.getItem('ACCOUNTNO').val();
    	var startTime = charForm.jqDom.find('[name=startTime]').val();
		var endTime =charForm.jqDom.find('[name=endTime]').val();
		if( accountno==""){
			alert('客户号不能为空');
			return ;
		}
		if( startTime!="" && endTime!="" && startTime>endTime){
			alert('#springMessage("view.cmc.log.list.msg.endTimeEarly")');
			return ;
		}
		if( startTime=="" || endTime=="" ){
			alert('交易时间不能为空');
			return ;
		}
	
    	
    	jcl.postJSON('/tms35/dataanalysic/phoneRechargeRegionpost', charParam, function(data){
    		var regionData = [];
    		var geoCoordMap = {};
    		$.each(data.list, function(i,ps){
    			if(regionData.indexOf([{name:ps['FROMCITY']},{name:ps['FROMCITY']}])==-1){
    				regionData.push([{name:ps['FROMCITY']},{name:ps['FROMCITY']}]);
    			}
    			regionData.push([{name:ps['FROMCITY']},{name:ps['TOCITY'],value:'txncode:'+ps['TXNCODE']}]);
    		});
    		
    		$.each(data.geocoordmaplist, function(i,ps){
    			geoCoordMap[ps['city']]=[ps['longitude'],ps['latitude']];
    			if(regionData.indexOf([{name:ps['FROMCITY']},{name:ps['FROMCITY']}])==-1){
    				//regionData.push([{name:ps['FROMCITY']},{name:ps['FROMCITY']}]);
    			}
    			regionData.push([{name:ps['FROMCITY']},{name:ps['TOCITY'],value:'txncode:'+ps['TXNCODE']}]);
    		});
    		showChartRegion(regionData,geoCoordMap);
    	});
    }
    
    
  //隐藏/展开相应的层
    function displayBoxContent(trigger, content){
    	trigger.on('click', function(){
    		if(content.is(':hidden')){
    			content.parent().show();
    		}else{
    			content.parent().hide();
    		}
    	})
    }


  
  function showChartRegion(regionData,geoCoordMap){
	    	var BJData = [
	    	    [{name:'北京'}, {name:'长春',value:40}],
	    	    [{name:'北京'},{name:'北京'}],
	    	    [{name:'北京'}, {name:'常州',value:10}],
	    	    [{name:'上海'},{name:'包头',value:95}],
	    	    [{name:'上海'},{name:'丹东',value:20}],
	    	    [{name:'上海'},{name:'大连',value:10}],
	    	    [{name:'广州'},{name:'福州',value:95}],
	    	    [{name:'广州'},{name:'太原',value:90}],
	    	    [{name:'广州'},{name:'北海',value:20}],
	    	    [{name:'广州'},{name:'海口',value:1000}]
	    	];


	    	var planePath = 'path://M1705.06,1318.313v-89.254l-319.9-221.799l0.073-208.063c0.521-84.662-26.629-121.796-63.961-121.491c-37.332-0.305-64.482,36.829-63.961,121.491l0.073,208.063l-319.9,221.799v89.254l330.343-157.288l12.238,241.308l-134.449,92.931l0.531,42.034l175.125-42.917l175.125,42.917l0.531-42.034l-134.449-92.931l12.238-241.308L1705.06,1318.313z';

	    	var convertData = function (data) {
	    	    var res = [];
	    	    for (var i = 0; i < data.length; i++) {
	    	        var dataItem = data[i];
	    	        var fromCoord = geoCoordMap[dataItem[0].name];
	    	        var toCoord = geoCoordMap[dataItem[1].name];
	    	        if (fromCoord && toCoord) {
	    	            res.push({
	    	                fromName: dataItem[0].name,
	    	                toName: dataItem[1].name,
	    	                coords: [fromCoord, toCoord]
	    	            });
	    	        }
	    	    }
	    	    return res;
	    	};

	    	var color = ['#a6c84c', '#ffa022', '#46bee9'];
	    	var series = [];
	    	if (regionData!='undefined'){
	    	[['充值', regionData]].forEach(function (item, i) {
	    	    series.push(
	    	    	    {
	    	        name: item[0],
	    	        type: 'lines',
	    	        zlevel: 1,
	    	        effect: {
	    	            show: true,
	    	            period: 6,
	    	            trailLength: 0.7,
	    	            color: '#fff',
	    	            symbolSize: 3
	    	        },
	    	        lineStyle: {
	    	            normal: {
	    	                color: color[i],
	    	                width: 0,
	    	                curveness: 0.2
	    	            }
	    	        },
	    	        data: convertData(item[1])
	    	    },
	    	    {
	    	        name: item[0],
	    	        type: 'lines',
	    	        zlevel: 2,
	    	        effect: {
	    	            show: true,
	    	            period: 6,
	    	            trailLength: 0,
	    	            symbol: planePath,
	    	            symbolSize: 15
	    	        },
	    	        lineStyle: {
	    	            normal: {
	    	                color: color[i],
	    	                width: 1,
	    	                opacity: 0.4,
	    	                curveness: 0.2
	    	            }
	    	        },
	    	        data: convertData(item[1])
	    	    },
	    	    {
	    	        name: '',
	    	        type: 'effectScatter',
	    	        coordinateSystem: 'geo',
	    	        zlevel: 1,
	    	        rippleEffect: {
	    	            brushType: 'stroke'
	    	        },
	    	        label: {
	    	            normal: {
	    	                show: true,
	    	                position: 'right',
	    	                formatter: '{b}'
	    	            }
	    	        },
	    	        symbolSize: function (val) {
	    	            return 5;
	    	        },
	    	        itemStyle: {
	    	            normal: {
	    	                color: color[i]
	    	            }
	    	        },
	    	        data: item[1].map(function (dataItem) {
	    	        	try{
	    	            return {
	    	                name: dataItem[1].name,
	    	                value: geoCoordMap[dataItem[1].name].concat([dataItem[1].value])
	    	            };
	    	        	}
	    	        	catch(e){
	    	        		return null;
	    	        	}
	    	        })
	    	    });
	    	});
	    	}
	    	var option = {
	    	    backgroundColor: '#404a59',
	    	    title : {
	    	        text: '手机充值地域视图',
	    	        subtext: '',
	    	        left: 'center',
	    	        textStyle : {
	    	            color: '#fff'
	    	        }
	    	    },
	    	    tooltip : {
	    	        trigger: 'item'
	    	    },
	    	    legend: {
	    	        orient: 'vertical',
	    	        top: 'bottom',
	    	        left: 'right',
	    	        data:['北京 Top10', '上海 Top10', '广州 Top10'],
	    	        textStyle: {
	    	            color: '#fff'
	    	        },
	    	        selectedMode: 'single'
	    	    },
	    	    geo: {
	    	        map: 'china',
	    	        label: {
	    	            emphasis: {
	    	                show: false
	    	            }
	    	        },
	    	        roam: true,
	    	        itemStyle: {
	    	            normal: {
	    	                areaColor: '#323c48',
	    	                borderColor: '#404a59'
	    	            },
	    	            emphasis: {
	    	                areaColor: '#323c48'
	    	            }
	    	        }
	    	    },
	    	    series: series
	    	};

	        
	        // 基于准备好的dom，初始化echarts实例
	        var myChart = echarts.init(document.getElementById('chartdiv'));
	        // 使用刚指定的配置项和数据显示图表。
	        myChart.setOption(option);  
  }
  
    function showMap(){
    	var series = [];
    	var option = {
	    	    backgroundColor: '#404a59',
	    	    title : {
	    	        text: '手机充值地域视图',
	    	        subtext: '',
	    	        left: 'center',
	    	        textStyle : {
	    	            color: '#fff'
	    	        }
	    	    },
	    	    tooltip : {
	    	        trigger: 'item'
	    	    },
	    	    legend: {
	    	        orient: 'vertical',
	    	        top: 'bottom',
	    	        left: 'right',
	    	        data:[],
	    	        textStyle: {
	    	            color: '#fff'
	    	        },
	    	        selectedMode: 'single'
	    	    },
	    	    geo: {
	    	        map: 'china',
	    	        label: {
	    	            emphasis: {
	    	                show: false
	    	            }
	    	        },
	    	        roam: true,
	    	        itemStyle: {
	    	            normal: {
	    	                areaColor: '#323c48',
	    	                borderColor: '#404a59'
	    	            },
	    	            emphasis: {
	    	                areaColor: '#2a333d'
	    	            }
	    	        }
	    	    },
	    	    series: series
	    	};

	        
	        // 基于准备好的dom，初始化echarts实例
	        var myChart = echarts.init(document.getElementById('chartdiv'));
	        // 使用刚指定的配置项和数据显示图表。
	        myChart.setOption(option); 
    }
   
    </script>
	</head>
	<body>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->   
  <div id="chartdiv" class="chartsDiv" align="center"></div>
</body>
</html>