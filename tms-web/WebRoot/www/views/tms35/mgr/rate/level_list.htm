<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>用户等级</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms35/js/commoncheck.js"></script>
<script type="text/javascript">
var g = "";
var table_name='TMS_RUN_USER',table_pk='USERID',user_name="USERNAME";
$(document).ready(function(){
	
	//组装表格
	/* g = $("#boxdiv").grid({
		title:'用户等级',
		toolbar:[
            {id:"btn-find",icon:"icon-tb-find",text:'#springMessage("view.tms.pub.btn.find")',action:'toggleQform'},
            {id:"rate-btn-edit", icon:"icon-tb-edit", text:"编辑"},
			{id:"rate-btn-single", icon:"icon-tb-edit", text:"单个评级", enable:'oneRowSelected'},
		    {id:"rate-btn-all", icon:"icon-tb-edit", text:"全部评级"},	
		],
		columns:[
			//{name:'rsid', width: 30, dataIndex:'RS_ID'},
			//{name:'rkid', width: 30, dataIndex:'RATEKIND_ID'},
			{name:'用户编号', width: 30, dataIndex:'USER_ID'},
			{name:'用户名称', width: 50, dataIndex:'USER_NAME'},
			{name:'风险分值', width: 20, dataIndex:'SCORE'},
			{name:'风险等级', width: 20, dataIndex:'RISKLEVEL'},
			{name:'更新时间', width: 30, dataIndex:'MODTIME',render:"datetime"}
		],
		items:[
		       {label:'用户编号',name:'USER_ID',type: 'text'},
		       {label:'用户名称', name:'USER_NAME',type: 'text'}, 
		       {label:'风险等级',name:'RISKLEVEL',type: 'text'},
		       {label:'更新时间',name:'MODTIME',type: 'text'}
		   ],
		    btns:[
			{id: 'quick_search_btn', text: '#springMessage("view.cmc.but.find")', action:'toggleQform'}],
	 
		ds:{
			url:"/tms35/rate/levelList",
			params:{TABLE_NAME:table_name,TABLE_PK:table_pk,USER_NAME:user_name},
			callback:function(list){
			}
		},
		pagebar: true,
		qform: {id:"qform", display:false}

	});
	g.goPage();*/
	 g = $("#boxdiv").grid({
			title:'用户等级',
			qform:{
				display: false,
				layout: 'list',
				items:[
            {label: '客户类型', name: 'userType',id:'userType' ,type:'selector',
	  items:[{text:'--请选择--', value:''}], ds:{type:'code', category:'cmc.customerType'}
},
					{label: '客户号', name: 'USER_ID', type: 'text'},
					{label: '登录名称', name: 'USER_NAME', type: 'text'},
					{label: '风险等级', name: 'RISKLEVEL', type: 'text'},
					{label: '更新时间', name: 'MODTIME',type: 'dateduration', duraSeparator:' 到  ', layout:'datetime', 
						items:[{name:'startTime'},{name:'endTime'}]},
					{label: '是否查询', name: 'isQuery',type:'hidden',value:'true',id:'isQuery'}
				],btns:[
					{id: 'quick_search_btn', text: '#springMessage("view.cmc.but.find")'}
				]
			},
			toolbar:[
	            {id : "btn-find",icon : "icon-tb-find",text : '#springMessage("view.tms.pub.btn.find")',action : 'toggleQform'},
	            {id:"rate-btn-edit", icon:"icon-tb-edit", text:"编辑",enable:'oneRowSelected'},
	            {id:"rate-btn-batch",iocn:"iocn-tb-edit",text:"批量评级", enable: "rowSelected"},
	            {id:"rate-btn-show",iocn:"iocn-tb-edit",text:"自定义批量评级"},
				{id:"rate-btn-single", icon:"icon-tb-edit", text:"单个评级", enable:'oneRowSelected'},
			    {id:"rate-btn-all", icon:"icon-tb-edit", text:"全部评级"}	
			],
			table:{
			columns:[
				//{name:'rsid', width: 30, dataIndex:'RS_ID'},
				//{name:'rkid', width: 30, dataIndex:'RATEKIND_ID'},
				{name:'客户号', width: 30, dataIndex:'USER_ID'},
				{name:'登录名称', width: 50, dataIndex:'USER_NAME'},
				{name:'风险分值', width: 20, dataIndex:'SCORE'},
				{name:'风险等级', width: 20, dataIndex:'RISKLEVEL'},
				{name:'更新时间', width: 30, dataIndex:'MODTIME',render:"datetime"}
			],
			
			ds:{
				url:"/tms35/rate/levelList",
				params:{isFirstEnter:"TRUE"},
				callback:function(list){
				}
			},
			pagebar: true,
			}

		});
		g.goPage();
	
	
	// 查询
	$("#quick_search_btn").click(function(){
		$('#isQuery').val('true');
		var userType =g.qform.jqDom.find('[name=userType]').val();
		if(userType == ""){
			alert("请选择客户类型");
			return;
		}
		var useid =  g.qform.jqDom.find('[name=USER_ID]').val();
		var username = g.qform.jqDom.find('[name=USER_NAME]').val();
		var risklevel = g.qform.jqDom.find('[name=RISKLEVEL]').val();
		var modtime = g.qform.jqDom.find('[name=startTime]').val();
		var isQuery = g.qform.jqDom.find('input[name=isQuery]').val();
		var tableName = g.qform.jqDom.find('input[name=table_name]').val();
		var tablePk = g.qform.jqDom.find('input[name=table_pk]').val();
		var userName = g.qform.jqDom.find('input[name=user_name]').val();
		var params = g.qform.jqDom.serialize();
		g.setDsParams(params);
		g.goPage();
	});
	
	//批量评级按钮
	$('#rate-btn-batch').click(function(){
		var userType =g.qform.jqDom.find('[name=userType]').val();
		if(userType == ""){
			alert("请选择客户类型");
			return;
		}
		var userType =g.qform.jqDom.find('[name=userType]').val();
		if(userType =="merchant"){
			var table_name='tms_run_merchants';
			var table_pk='MEMBER_NO'
		}
		if(userType =="customer"){
			var table_name='tms_run_user';
			var table_pk='USERID';
		}
		if(userType =="posMerchant"){
			var table_name='tms_run_merchant_pos';
			var table_pk='MRCH_NO';
		}
		var url_para = '';
		var rows = g.table.selectedRows();
		if(rows.length == 0){ 
			//alert('请选中多条记录');
			return;
		}
		
		for(var i = 0;i<rows.length;i++){
			var j = 0;
			url_para = 'USER_ID='+rows[i].USER_ID +'&RR_ID='+rows[i].RR_ID+'&RS_ID='+rows[i].RS_ID+'&TXNID='+rows.TXNID+'&LEVEL_SCORE='+rows[i].LEVEL_SCORE + '&TABLE_NAME='+table_name+'&TABLE_PK='+table_pk;
			jcl.postJSON('/tms35/rate/batchRate', url_para, function(data1){
				j++
				if(i==j){
					alert("评级成功");
					g.goPage();
				}
			});
			
		}
		
		return false;
	});
  //自定义批量评级
  $('#rate-btn-show').click(function(){
	    $('#isQuery').val('true');
		var userType =g.qform.jqDom.find('[name=userType]').val();
		var userid =  g.qform.jqDom.find('[name=USER_ID]').val();
		var username = g.qform.jqDom.find('[name=USER_NAME]').val();
		var risklevel = g.qform.jqDom.find('[name=RISKLEVEL]').val();
		var isQuery = g.qform.jqDom.find('input[name=isQuery]').val();
		var startTime = g.qform.jqDom.find('[name=startTime]').val();
		var endTime = g.qform.jqDom.find('[name=endTime]').val();
		if(userType == ""){
			alert("请选择客户类型");
			return;
		}
		if(userid==''&&
				username==''&&
				risklevel==''&&
				startTime==''&&
				endTime==''){
			alert("请填写批量评级查询条件");
			return;
		}
		if(userType =="merchant"){
			var tablename='tms_run_merchants';
			var table_pk='MEMBER_NO'
			
		}
		if(userType =="customer"){
			var tablename='tms_run_user';
			var table_pk='USERID';
		
		}
		if(userType =="posMerchant"){
			var tablename='tms_run_merchant_pos';
			var table_pk='MRCH_NO';
		}
		
		var params =  "TABLE_NAME="+tablename+"&TABLE_PK="+table_pk+"&USREID="+userid+"&USERNAME="+username+"&RISKLEVEL="+risklevel+"&startTime="+startTime+"&endTime="+endTime+"&isQuery="+isQuery;
		jcl.postJSON('/tms35/rate/queryRate', params, function(data1){

			$('body').append('<div id=\"process_ps_value\"></div>');
			$('#process_ps_value').empty();
			var a = '<table><tr><td><div id="ProgressBarSide" style="color:Silver;border-width:1px;border-style:Solid;width:300px;"><div id="ProgressBar" style="background-color:Blue; height:21px; width:0%;" align="center"></div></div></td></tr></table>';
			ps_value_dialog.addDom('process_ps_value');
			ps_value_dialog.show();
			$("#process_ps_value").append(a);
			 var pos=0;
			var timer = setInterval(function()
			 {  
			 	var p_param = "TABLE_NAME="+tablename; 
			 	jcl.postJSON('/tms35/rate/rateCompletePert', p_param, function(data1){ 
				pos = data1.percent;
			     $('#ProgressBar').width(pos + "%");
				 $('#ProgressBar').html(pos + "%");
				 
				 if(pos==-2){ps_value_dialog.hide();clearInterval(timer);alert("评级过程中发生异常！");g.goPage();}
				 
				 if(pos>=100){
				 	clearInterval(timer);
				    $("#process_ps_value table tr").append('<td><input type="button" id="c_b" value="完成"/></td>');
					$('#c_b').click(function(){
						ps_value_dialog.hide();
						g.goPage();
					});
				 }
				 },false);
			 },500);//定时调用 
			 
			g.goPage();
		},false);
		return false;
	});
		
		
// 单个评级按钮	
	$('#rate-btn-single').click(function(){
		var userType =g.qform.jqDom.find('[name=userType]').val();
		if(userType == ""){
			alert("请选择客户类型");
			return;
		}
		if(userType =="merchant"){
			var table_name='tms_run_merchants';
			var table_pk='MEMBER_NO'
		}
		if(userType =="customer"){
			var table_name='tms_run_user';
			var table_pk='USERID';
		}
		if(userType =="posMerchant"){
			var table_name='tms_run_merchant_pos';
			var table_pk='MRCH_NO';
		}
		var url_para = '';
		var row = g.table.selectedRows();
		if(row.length == 0){ 
			//alert('#springMessage("view.tms.pub.checkbox.msg0")!');
			return;
		}
		url_para = 'USER_ID='+row[0].USER_ID +'&RR_ID='+row[0].RR_ID+'&RS_ID='+row[0].RS_ID+'&TXNID='+row[0].TXNID+'&LEVEL_SCORE='+row[0].LEVEL_SCORE + '&TABLE_NAME='+table_name+'&TABLE_PK='+table_pk;
		jcl.postJSON('/tms35/rate/singleRate', url_para, function(data1){
			alert("评级成功");
			g.goPage();
		});
		return false;
	});
	
	
	//新建编辑单
	var editDialog = new jcl.ui.Dialog({title:'修改风险等级', draggable: true});
	var editForm = new jcl.ui.Form({
		display: false,
		layout: 'list',
		items:[
		   	{label: 'rsid', name: 'RS_ID',type:'hidden'},
		   	{label: 'rateKindId', name: 'RATEKIND_ID',type:'hidden'},
			{label: '客户号', name: 'USER_ID',  required:true},
			{label: '登录名称', name: 'USER_NAME',  required:true},	
			{label: '风险分数', name: 'SCORE', required:true},
			{label: '风险等级', name: 'RISKLEVEL', required:true},
			//,type:'selector',
				//items:[{text:'--请选择--', value:''}], ds:{type:'code', category:'tms.userrate.risklevel'}
			{label: '更新时间', name: 'MODTIME',  required:true, type: 'date', layout:'datetime'}
		],btns:[
			{text: '#springMessage("view.tms.pub.btn.save")', cls: 'updateBtn'},
			{text: '#springMessage("view.tms.pub.btn.cancel")', cls: 'cancelBtn'}
		]
	
	});
	  editDialog.addDom(editForm.jqDom);
	 editForm.getItem('USER_ID').disable(true);
	    editForm.getItem('USER_NAME').disable(true);
	    editForm.getItem('RISKLEVEL').disable(true);
	    
	g.toolbar.onClick('#rate-btn-edit',function() {
		 var row =  g.selectedRows();
		 var userid = row[0]["USER_ID"];
		 var username = row[0]["USER_NAME"];
		 var score = row[0]["SCORE"];
		 var risklevel =  row[0]["RISKLEVEL"];
		 var modtime = row[0]["MODTIME"];
		 var ratekindId = row[0]["RATEKIND_ID"];
		 var rsId = row[0]["RS_ID"];
		 var format = function(modtime, format) {
		  var t = new Date(modtime);
				var tf = function(i) {
					return (i < 10 ? '0' : '') + i
				};
				return format.replace(/yyyy|MM|dd|HH|mm|ss/g, function(a) {
					switch (a) {
					case 'yyyy':
						return tf(t.getFullYear());
						break;
					case 'MM':
						return tf(t.getMonth() + 1);
						break;
					case 'mm':
						return tf(t.getMinutes());
						break;
					case 'dd':
						return tf(t.getDate());
						break;
					case 'HH':
						return tf(t.getHours());
						break;
					case 'ss':
						return tf(t.getSeconds());
						break;
					}
				})
			};
		 editForm.set({'USER_ID':userid,
				'USER_NAME': username,
				'SCORE': score,
				'RISKLEVEL':risklevel,
				'MODTIME':format(modtime,"yyyy-MM-dd HH:mm:ss"),
				'RATEKIND_ID':ratekindId,
				'RS_ID':rsId
				});
		 editDialog.show();
	 });
	
	
    editForm.jqDom.find('.updateBtn').click(function(){
    	var score = editForm.getItem('SCORE').val();
    	var ratekindId =  editForm.getItem('RATEKIND_ID').val();
    	var rsId = editForm.getItem('RS_ID').val();
    	if(score<-100){
    		alert("风险评分不能小于-100");
    		return;
    	}
    	if(score>100){
    		alert("风险评分不能大于100");
    		return;
    	}
    	if(ratekindId == "" || rsId==""){
    		alert("先评完级再修改风险等级");
    		return;
    	}
    	var userType =g.qform.jqDom.find('[name=userType]').val();
		var params = $.param(editForm.data())+'&userType='+userType;
	        jcl.postJSON('/tms35/rate/editRiskLevel', params,
	        function(data) {
	            editDialog.hide();
	            jcl.msg.info('#springMessage("view.tms.pub.edit.success")');
	            g.goPage();
	        });
	        
}).end().find('.cancelBtn').click(function(){
	editDialog.hide();
});  

//});
		
		
	var ps_value_dialog = new jcl.ui.Dialog({
					"title" : '评级进度', 
					"zindex" : '701', 
					width:400,
					closeable:false,
					marginTop: 0,
					draggable : true
				});
	// 全部评级按钮	
	$('#rate-btn-all').click(function(){
		var userType =g.qform.jqDom.find('[name=userType]').val();
		if(userType == ""){
			alert("请选择客户类型");
			return;
		}
		if(userType =="merchant"){
			var table_name='tms_run_merchants';
			var table_pk='MEMBER_NO'
		}
		if(userType =="customer"){
			var table_name='tms_run_user';
			var table_pk='USERID';
		}
		if(userType =="posMerchant"){
			var table_name='tms_run_merchant_pos';
			var table_pk='MRCH_NO';
		}
		var url_para = '';
		url_para += "TABLE_NAME="+table_name+"&TABLE_PK="+table_pk;
		jcl.postJSON('/tms35/rate/allRate', url_para, function(data1){
			
			$('body').append('<div id=\"process_ps_value\"></div>');
			$('#process_ps_value').empty();
			var a = '<table><tr><td><div id="ProgressBarSide" style="color:Silver;border-width:1px;border-style:Solid;width:300px;"><div id="ProgressBar" style="background-color:Blue; height:21px; width:0%;" align="center"></div></div></td></tr></table>';
			ps_value_dialog.addDom('process_ps_value');
			ps_value_dialog.show();
			$("#process_ps_value").append(a);
			 var pos=0;
			var timer = setInterval(function()
			 {  
			 	var p_param = "TABLE_NAME="+table_name; 
			 	jcl.postJSON('/tms35/rate/rateCompletePert', p_param, function(data1){ 
				pos = data1.percent;
			     $('#ProgressBar').width(pos + "%");
				 $('#ProgressBar').html(pos + "%");
				 
				 if(pos==-2){ps_value_dialog.hide();clearInterval(timer);alert("评级过程中发生异常！");g.goPage();}
				 
				 if(pos>=100){
				 	clearInterval(timer);
				    $("#process_ps_value table tr").append('<td><input type="button" id="c_b" value="完成"/></td>');
					$('#c_b').click(function(){
						ps_value_dialog.hide();
						g.goPage();
					});
				 }
				 },false);
			 },500);//定时调用 
			 
			g.goPage();
		},false);
		return false;
		
		/*var table_name='TBL_USER';
		var table_pk='USER_ID';
		var url_para = '';
		url_para += "TABLE_NAME="+table_name+"&TABLE_PK="+table_pk;
		jcl.postJSON('/tms35/rate/allRate', url_para, function(data1){
		},false);
		
		$('body').append('<div id=\"process_ps_value\"></div>');
			$('#process_ps_value').empty();
			var a = '<table><tr><td><div id="ProgressBarSide" style="color:Silver;border-width:1px;border-style:Solid;width:300px;"><div id="ProgressBar" style="background-color:Blue; height:21px; width:0%;" align="center"></div></div></td></tr></table>';
			ps_value_dialog.addDom('process_ps_value');
			ps_value_dialog.show();
			$("#process_ps_value").append(a);
			 var pos=0;
			var timer = setInterval(function()
			 {  
			 	var p_param = "TABLE_NAME="+table_name; 
			 	jcl.postJSON('/tms35/rate/rateCompletePert', p_param, function(data1){ 
				pos = data1.percent;
			     $('#ProgressBar').width(pos + "%");
				 $('#ProgressBar').html(pos + "%");
				 if(pos>=100){
					clearInterval(timer);
				    $("#process_ps_value table tr").append('<td><input type="button" id="c_b" value="完成"/></td>');
					$('#c_b').click(function(){
						ps_value_dialog.hide();
						g.goPage();
					});
				 }
				 },false);
			 },500);//定时调用 
			 
			g.goPage();
		return false;*/
	});
	
});


</script>

</head>
<body>

<div id="boxdiv" class="box"></div>
	
</body>
</html>
