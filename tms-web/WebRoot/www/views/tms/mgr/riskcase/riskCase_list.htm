<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>风险案件管理</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery-ui.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms35/js/commoncheck.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms35/js/json2.js"></script>
<script type="text/javascript">
	var g = "";
	$(document).ready(function() {
		//组装表格     
		g = new jcl.ui.Grid({
			title : '风险案件管理列表',
			width : 1550,
			marginTop : 10,
			qform : {
				display : false,
				layout : 'list',
				items : [{label : '案件编号',name : 'CASE_NO',type : 'text'},
	                     {label : '案件标题',name : 'TITLE',type : 'text'}, 
	                     {label : '立案来源',name : 'SRC_TYPE',type : 'selector',
	                    	 items : [ {	text : '--请选择--',	value : ''} ],
	                    	 ds : {	type : 'code',	category : 'tms.case.src.type'}}, 
	                      {label : '案件发生时间',type : 'dateduration',duraSeparator : ' 到  ',layout : 'datetime',
	                    		 items : [ {	name : 'CUR_DATE_START'}, {	name : 'CUR_DATE_END'} ]}, 
	                      {label : '立案时间',type : 'dateduration',duraSeparator : ' 到 ',layout : 'datetime',
	                    		 items : [ {	name : 'CREATED_DATE_START'}, {	name : 'CREATED_DATE_END'} ]}, 
	                      {label : '是否再调查案件',name : 'IS_RE_CHECK',type : 'selector',
	                    		 items : [ {	text : '--请选择--',	value : ''}, {	text : '是',	value : '1'}, {	text : '否',	value : '0'} ],
	                    		 ds : {	type : 'code',	category : ''}},
	                      {label : '客户号',name : 'USERID',type : 'text'}, 
	                      {label : '客户名称',name : 'LOGIN_NAME',type : 'text'}, 
	                      {label : '注册手机号',name : 'MOBILE',type : 'text'} ],
	                      btns : [ {id : 'quick_search_btn',text : '#springMessage("view.cmc.but.find")'}, {id : 'btn-query-reset',text : '重置'} ]},
             toolbar : [ {id : "btn-find",icon : "icon-tb-find",text : '#springMessage("view.tms.pub.btn.find")',action : 'toggleQform'}, 
                         {id : "btn-add",icon : "icon-tb-add",text : '#springMessage("view.tms.pub.btn.new")'}, 
                         {id : "btn-edit",icon : "icon-tb-edit",text : '#springMessage("view.tms.pub.btn.edit")',enable : 'oneRowSelected'}, 
                         {id : "btn-del",icon : "icon-tb-del",text : '#springMessage("view.tms.pub.btn.del")',enable : 'rowSelected'}, 
                         {id : "btn-invest",icon : "icon-tb-add",text : '调查信息',enable : 'oneRowSelected'}],
             table : {
		           	  columns : [ 
		           	      {name : '案件编号',width : 10,dataIndex : 'CASE_NO'}, 
		           	      {name : '案件标题',width : 27,dataIndex : 'TITLE'}, 
		           	      {name : '立案来源',width : 10,dataIndex : 'SRC_TYPE',render : 'tms.case.src.type'}, 
		           	      {name : '案件发生时间',width : 12,dataIndex : 'CUR_DATE',render : 'date'},  
		           	      {name : '立案时间',width : 17,dataIndex : 'CREATED_DATE',render : 'datetime'},
		           	      {name : '是否再调查案件',width : 9,dataIndex : 'IS_RE_CHECK',render : 'common.is'}, 
		           	      {name : '立案人',width : 15,dataIndex : 'OPERATOR'}, 
		           	      {name : '客户名称',width : 20,dataIndex : 'CUSNAME'}, 
		           	      {name : '客户号',width : 17,dataIndex : 'USERID'}, 
		           	      {name : '注册手机号',width : 17,dataIndex : 'MOBILE'}, 
		           	      {name : '客户状态',width : 8,dataIndex : 'STATUS',} ],	
				ds : {
					url : "/tms/riskCase/list",
					params : {}
				},
				pagebar : true
			}
		});
		g.goPage();

		$("#btn-query-reset").click(function() {
			g.qform.reset();
		});

		$("#quick_search_btn").click(function() {
			var params = g.qform.jqDom.serialize();
			g.setDsParams(params);
			g.goPage();

		});

		//新增
		var addDialog = new jcl.ui.Dialog({
			title : '新建案件',
			draggable : true
		});

		var addForm = new jcl.ui.Form({
			display : false,
			layout : 'list',
			items : [ {
				label : '案件来源',
				name : 'SRC_TYPE',
				type : 'selector',
				title : '--请选择--',
				items : [],
				ds : {
					type : 'code',
					category : 'tms.case.src.type'
				},
				required : true},
			   {label : '案件标题',name : 'TITLE',type : 'text'}, 
			   {label : '疑似欺诈客户',name : 'USERID',type : 'text'}, 
			   {label : '疑似欺诈账户',name : 'ACCOUNTID',type : 'text',	required : true},
			   {label : '交易流水号',name : 'TXNCODE',type : 'text'}, 
			   {label : '疑似欺诈金额',name : 'AMOUNT',type : 'text'}, 
			   {label : '案件发生时间',name : 'CUR_DATE',type : 'date',required : true},
			   {label : '备注',name : 'DESCR',type : 'textarea'} ],
			btns : [ {
				text : '#springMessage("view.tms.pub.btn.save")',
				cls : 'addBtn'
			}, {
				text : '#springMessage("view.tms.pub.btn.cancel")',
				cls : 'cancelBtn'
			} ]
		});
		addDialog.addDom(addForm.jqDom);

		g.toolbar.onClick('#btn-add', function() {
			addForm.reset();
			addDialog.show();
		});

		addForm.jqDom.find('.addBtn').click(function() {

			var src_type = addForm.getItem('SRC_TYPE').val();
			//var userid = addForm.getItem('USERID').val();
			var cur_date = addForm.getItem('CUR_DATE').val();
			var amount = addForm.getItem('AMOUNT').val();
			if (src_type == "") {
				alert("请选择案件来源");
				return;
			}
			//if (userid == "" || (!/^[0-9]*$/.test(userid))) {
			//alert("请输入客户号且必须是数字");
			//return;
			//}
			if (cur_date == "") {
				alert("请选择案件发生日期");
				return;
			}
			if (amount != "" && (!/^[0-9]*$/.test(amount))) {
				alert("金额请填写正确的数字");
				return;
			}
			var params = $.param(addForm.data());//addForm.jqDom.serialize();
			jcl.postJSON('/tms/riskCase/add', params, function(data) {
				addDialog.hide();
				jcl.msg.info('#springMessage("view.cmc.pub.add.success")');
				g.goPage();
			});

		}).end().find('.cancelBtn').click(function() {
			addDialog.hide();
		});

		//编辑
		var editDialog = new jcl.ui.Dialog({
			title : '编辑案件',
			draggable : true
		});

		var editForm = new jcl.ui.Form({
			display : false,
			layout : 'list',
			items : [ {label : '主键id',	name : 'UUID',type : 'hidden'}, 
			          {label : '案件来源',name : 'SRC_TYPE',	type : 'selector',title : '--请选择--',items : [],
				ds : {type : 'code',category : 'tms.case.src.type'},required : true}, 
				{label : '案件标题',name : 'TITLE',type : 'text'	}, 
				{label : '疑似欺诈客户',name : 'USERID',type : 'text'}, 
				{label : '疑似欺诈账户',name : 'ACCOUNTID',type : 'text',required : true},
				{label : '疑似欺诈金额',	name : 'AMOUNT',type : 'text'}, 
				{label : '交易流水号',name : 'TXNCODE',type : 'text'	},
				{label : '案件发生时间',name : 'CUR_DATE',type : 'date',required : true}, 
				{label : '备注',	name : 'DESCR',type : 'textarea'}
			],
			btns : [ {
				text : '#springMessage("view.tms.pub.btn.save")',
				cls : 'editBtn'
			}, {
				text : '#springMessage("view.tms.pub.btn.cancel")',
				cls : 'cancelBtn'
			} ]
		});
		editDialog.addDom(editForm.jqDom);

		g.toolbar.onClick('#btn-edit', function() {
			var rows = g.selectedRows();
			if (rows.length == 0) {
				alert('#springMessage("view.cmc.pub.checkbox.msg0")!');
				return;
			}
			if (rows.length > 1) {
				alert('#springMessage("view.cmc.pub.checkbox.msg1")!');
				return;
			}

			var uuid = rows[0]["UUID"];
			editForm.reset();
			jcl.postJSON('/tms/riskCase/get', 'UUID=' + uuid, function(data) {
				editForm.set(data.caseMap, {
					'UUID' : 'UUID',
					'SRC_TYPE' : 'SRC_TYPE',
					'USERID' : 'USERID',
					'TITLE' : 'TITLE',
					'TXNCODE' : 'TXNCODE',
					'ACCOUNTID' : 'ACCOUNTID',
					'MOBILE' : 'MOBILE',
					'AMOUNT' : 'AMOUNT',
					'CUR_DATE' : 'CUR_DATE',
					'DESCR' : 'DESCR'
				});

			});
			editDialog.show();
		});

		editForm.jqDom.find('.editBtn').click(function() {

			var src_type = editForm.getItem('SRC_TYPE').val();
			//var userid = editForm.getItem('USERID').val();
			var cur_date = editForm.getItem('CUR_DATE').val();
			var amount = editForm.getItem('AMOUNT').val();
			if (src_type == "") {
				alert("请选择案件来源");
				return;
			}
			//if (userid == "" || (!/^[0-9]*$/.test(userid))) {
			//	alert("请输入客户号且必须是数字");
			//return;
			//}
			if (cur_date == "") {
				alert("请选择案件发生日期");
				return;
			}
			if (amount != "" && (!/^[0-9]*$/.test(amount))) {
				alert("金额请填写正确的数字");
				return;
			}
			var params = $.param(editForm.data());//addForm.jqDom.serialize();
			jcl.postJSON('/tms/riskCase/mod', params, function(data) {
				editDialog.hide();
				jcl.msg.info('#springMessage("view.tms.pub.edit.success")');
				g.goPage();
			});

		}).end().find('.cancelBtn').click(function() {
			editDialog.hide();
		});

		//删除
		g.toolbar.onClick('#btn-del', function() {
			var rows = g.selectedRows();
			if (rows.length == 0) {
				alert('#springMessage("view.tms.pub.checkbox.msg0")!');
				return;
			}
			if (confirm('#springMessage("view.tms.pub.del.confirm")?')) {
				var list = [];
				$.each(rows, function(i, row) {
					list.push($.extend({}, row));
				});

				var json_data = JSON.stringify({
					'del' : list
				});
				var json_data_encode = encodeURIComponent(json_data);
				var url_para = "postData=" + json_data_encode;

				jcl.postJSON('/tms/riskCase/del', url_para, function(data) {
					alert('#springMessage("view.tms.pub.del.success")');
					g.goPage();

				});
			} else {
				return;
			}
		});

		g.toolbar.onClick('#btn-invest', function() {
			var rows = g.selectedRows();
			if (rows.length == 0) {
				alert('#springMessage("view.cmc.pub.checkbox.msg0")!');
				return;
			}
			if (rows.length > 1) {
				alert('#springMessage("view.cmc.pub.checkbox.msg1")!');
				return;
			}

			var caseUuid = rows[0]["UUID"];
			//清空上一个记录
			$("input[name='DISPOSAL']").attr("checked", false);
			$("input[name='IS_AMOUNT_CORRECT'][value=0]").attr("checked", true);
			$("input[name='IS_BANK_PROVE'][value=0]").attr("checked", true);
			$("input[name='IS_PHONE_CHECK'][value=0]").attr("checked", true);
			$("input[name='IS_OWNER'][value=0]").attr("checked", true);
			$("select[name='FINAL_DECISION']").val("");
			$("#DESCR").attr("value", "");
			$("#saveInv").removeAttr("disabled","disabled");
			$("#submitInv").removeAttr("disabled","disabled");
			jcl.postJSON('/tms/riskCase/getInfo', 'caseUuid=' + caseUuid, function(data) {
				var disposals = data.caseInvest.DISPOSAL;
				if (null != disposals) {
					$("input[name='DISPOSAL']").filter(function(index, val) {
						if (disposals.indexOf(this.value) >= 0)
							return this.checked = true;
					});
				}
				var isAmountCorrect = data.caseInvest.IS_AMOUNT_CORRECT;
				if (null != isAmountCorrect) {
					$("input[name='IS_AMOUNT_CORRECT']").filter(function(index, val) {
						if (isAmountCorrect.indexOf(this.value) >= 0)
							return this.checked = true;
					});
				}

				var isBankProv = data.caseInvest.IS_BANK_PROVE;
				if (null != isBankProv) {
					$("input[name='IS_BANK_PROVE']").filter(function(index, val) {
						if (isBankProv.indexOf(this.value) >= 0)
							return this.checked = true;
					});
				}

				var isPhoneCheck = data.caseInvest.IS_PHONE_CHECK;
				if (null != isPhoneCheck) {
					$("input[name='IS_PHONE_CHECK']").filter(function(index, val) {
						if (isPhoneCheck.indexOf(this.value) >= 0)
							return this.checked = true;
					});
				}

				var isOwner = data.caseInvest.IS_OWNER;
				if (null != isOwner) {
					$("input[name='IS_OWNER']").filter(function(index, val) {
						if (isOwner.indexOf(this.value) >= 0)
							return this.checked = true;
					});
				}

				var finalDecision = data.caseInvest.FINAL_DECISION;
				if (null != finalDecision) {
					$("select[name='FINAL_DECISION']").val(finalDecision);
				}
				if (null != finalDecision) {
					$("#DESCR").attr("value", data.caseInvest.DESCR);
				}

				var caseStatus = data.status;
				if("1"==caseStatus){
					$("#saveInv").attr("disabled","disabled");
					$("#submitInv").attr("disabled","disabled");
				}
			});

			inputDialog = new jcl.ui.Dialog({
				title : '调查信息'
			});
			$("#inputUL input[name='CASE_UUID']").attr("value", caseUuid);
			inputDialog.addDom('inputUL');
			inputDialog.show();

		});

		$("#inputUL .inputBtn").click(function() {
			if (inputForm.FINAL_DECISION.value == "") {
				alert("请选择一个调查结果");
				return;
			}
			inputForm.submit();
		}).end().find('#inputUL .sureBtn').click(function() {
			var params = [];
			params.push({
				name : 'CASE_UUID',
				value : inputForm.CASE_UUID.value
			});
			jcl.postJSON('/tms/riskCase/modStatus', params, function(data) {
				$("#saveInv").attr("disabled","disabled");
				$("#submitInv").attr("disabled","disabled");
				jcl.msg.info('修改成功');
			});
		}).end().find('#inputUL .cancelBtn').click(function() {
			inputDialog.hide();
		});
		;
	});
</script>

<style type="text/css">
.grid {
	margin: 0 10px;
	padding-right: 10px;
}
</style>

</head>
<body>

	<div id="boxdiv" class="box"></div>

	<div style="display: none;">
		<ul style="list-style: none;" id="exportUL">
			<li class="list-box-item"><a href="#" id="txt">TXT</a></li>
			<li class="list-box-item"><a href="#" id="csv">CSV</a></li>
			<li class="list-box-item"><a href="#" id="xls">Excel2003及以下版本</a></li>
			<li class="list-box-item"><a href="#" id="xlsx">Excel2007及以上版本</a></li>
		</ul>
	</div>
	<div style="display: none;">
		<div style="list-style: none;" id="inputUL">
			<form name="inputForm" class="form" action="/tms-web/tms/riskCase/addInfo" method="post">
				<input name="CASE_UUID" type="hidden" value="">
					<ul class="form-items">
						<li class="form-item" style="width: 100%;"><div class="form-item-label" style="width: 130px;">
								<font color="red">*</font>金额是否核对无误:
							</div>
							<div class="form-item-content">
								<div>
									<input name="IS_AMOUNT_CORRECT" type="radio" value="1"> 是<input name="IS_AMOUNT_CORRECT" type="radio" value="0" checked="checked"> 否 
								</div>
							</div></li>
						<li class="form-item" style="width: 100%;"><div class="form-item-label" style="width: 130px;">
								<font color="red">*</font>是否有银行纸质信息:
							</div>
							<div class="form-item-content">
								<div>
									<input name="IS_BANK_PROVE" type="radio" value="1"> 是<input name="IS_BANK_PROVE" type="radio" value="0" checked="checked"> 否 
								</div>
							</div></li>

						<!--  <li class="form-item" style="width: 100%;"><div class="form-item-label" style="width: 130px;">选择文件:</div>
							<div class="form-item-content">
								<input name="FILE_UUID" type="file">
							</div></li>-->

						<li class="form-item" style="width: 100%;"><div class="form-item-label" style="width: 130px;">
								<font color="red">*</font>是否电话确认:
							</div>
							<div class="form-item-content">
								<div>
									<input name="IS_PHONE_CHECK" type="radio" value="1"> 是<input name="IS_PHONE_CHECK" type="radio" value="0" checked="checked"> 否 
								</div>
							</div></li>
						<li class="form-item" style="width: 100%;"><div class="form-item-label" style="width: 130px;">
								<font color="red">*</font>是否确认为本人:
							</div>
							<div class="form-item-content">
								<div>
									<input name="IS_OWNER" type="radio" value="1"> 是<input name="IS_OWNER" type="radio" value="0" checked="checked"> 否 
								</div>
							</div></li>
						<li class="form-item" style="width: 100%;"><div class="form-item-label" style="width: 130px;">处置操作:</div>
							<div class="form-item-content">
								<div>
									<input name="DISPOSAL" id="DISPOSAL" type="checkbox" value="1"> 冻结账户 <input name="DISPOSAL" id="DISPOSAL" type="checkbox" value="2"> 禁止客户 <input name="DISPOSAL" id="DISPOSAL" type="checkbox" value="3"> 暂停结算 
								</div>
							</div></li>
						<li class="form-item" style="width: 100%;"><div class="form-item-label" style="width: 130px;">
								<font color="red">*</font>调查结果:
							</div>
							<div class="form-item-content">
								<div class="selector" style="width: 180px">
									<select name="FINAL_DECISION" id="FINAL_DECISION" class="selector-itext" style="width: 180px">
										<option value="">请选择</option>
										<option value="0">确认风险转赔付</option>
										<option value="1">无风险结案</option>
									</select>

								</div>
							</div></li>
						<li class="form-item" style="width: 100%;"><div class="form-item-label" style="width: 130px;">备注:</div>
							<div class="form-item-content">
								<textarea name="DESCR" id="DESCR" class="ttext"></textarea>
							</div></li>
						<li class="clear"><input type="text" style="display: none"></li>

						<div class="form-btns" style="padding-left: 140px;">
							<input type="button" value="保存" class="btn inputBtn" id="saveInv" title="仅保存调查结果，不提交"> 
							<input type="button" value="确定" class="btn sureBtn" id="submitInv" title="已提交调查结果的案件不可以再次提交"> 
							<input type="button" value="取消" class="btn cancelBtn">
						</div>

					</ul>
			</form>
		</div>
	</div>
</body>
</html>