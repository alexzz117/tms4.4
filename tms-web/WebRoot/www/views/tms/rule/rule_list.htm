<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>#springMessage("view.tms.rule.list")</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms/js/commoncheck.js"></script>
<script type="text/javascript">
$(document).ready(function(){
	
	//组装表格
	var g = $("#boxdiv").grid({
		title:'#springMessage("view.tms.rule.list")',
		columns:[
			{name:'#springMessage("view.tms.rule.add.rulename")', width: 50, dataIndex:'RULENAME'},
			{name:'#springMessage("view.tms.rule.add.trade")', width: 40, dataIndex:'TXNNAME'},
			{name:'#springMessage("view.tms.rule.add.desc")', width: 80, dataIndex:'RULEDESC'},
			{name:'#springMessage("view.tms.rule.add.score")', width: 20, dataIndex:'SCORE'},
			{name:'#springMessage("view.tms.rule.add.weight")', width: 20, dataIndex:'WEIGHT'},
			{name:'#springMessage("view.tms.rule.add.disposal")', width: 20, dataIndex:'DISPOSAL',render:'tms.rule.disposal'},
			{name:'#springMessage("view.tms.rule.add.status")', width: 20, dataIndex:'STATUS',render:'tms.mgr.rulestatus'}
		],
		ds:{
			url:"/tms/rule/list",
			params:{},
			callback:function(list){
				for(var i = 0; i < list.length; i++){
					list[i]['WEIGHT'] += '%';
				}
			}
		},
		toolbar:[
			{id:"btn-find", icon:"icon-tb-find", text:'#springMessage("view.tms.pub.btn.find")', toggleQform:true},
			{id:"btn-add", icon:"icon-tb-add", text:'#springMessage("view.tms.pub.btn.new")'},
			{id:"btn-edit", icon:"icon-tb-edit", text:'#springMessage("view.tms.pub.btn.edit")'},
			{id:"btn-del", icon:"icon-tb-del", text:'#springMessage("view.tms.pub.btn.del")'},
			{id:"btn-expert", icon:"icon-tb-add", text:'引入专家规则'},
			{id:"btn-used", icon:"icon-tb-edit", text:'#springMessage("view.tms.pub.btn.used")'},
			{id:"btn-unused", icon:"icon-tb-edit", text:'#springMessage("view.tms.pub.btn.unused")'}
		],
		pagebar: true,
		qform: {id:"qform", display:false}

	});
	g.goPage();
	
	
	$("#quick_search_btn").click(function(){
		var rulename = $('#RULENAME').val();

		if(Trim(rulename).length > 0 && !checkeSpecialCode(Trim(rulename))){
			alert('#springMessage("view.tms.rule.add.rulename")'+'不能包含特殊字符');
			return $('#RULENAME').focus();
		}

		var params = $('#qform').serialize();
		g.setDsParams(params);
		g.goPage();
	});
	$("#btn-add").click(function(){
		jcl.go('/tms/rule/add');
	});
	
	$("#btn-expert").click(function(){
		jcl.go('/tms/expert/rule_expertlist');
	});
	
	$("#btn-edit").click(function(){
		var rows = g.selectedRows();
		if(rows.length == 0){ 
			alert('#springMessage("view.tms.pub.checkbox.msg0")!');
			return;
		}
		if(rows.length>1){
			alert('#springMessage("view.tms.pub.checkbox.msg1")!');
			return;
		}
		var ruleId = [];
		$.each(rows, function(i,row){
			ruleId.push('ruleId=' + row['RULEID']);
		});            
		jcl.go('/tms/rule/edit?' + ruleId[0]);
	});
	

	
	$("#btn-del").click(function(){
		//TODO: 安全起见，应逐条删除
		var rows = g.selectedRows();
			if(rows.length == 0){ 
				alert('#springMessage("view.tms.pub.checkbox.msg0")!');
				return;
			}
		if(confirm('#springMessage("view.tms.pub.del.confirm")?')){
			var ruleId = [];
			$.each(rows, function(i, row){
				ruleId.push('ruleId='+row['RULEID']);
			});
			var params = ruleId.join('&');
			jcl.postJSON('/tms/rule/del', params, function(data){
				alert('#springMessage("view.tms.pub.del.success")!');
				g.goPage();
			});
		}else{
			return ;
		}
	});
	
	
	
	$("#btn-used").click(function(){
		var rows = g.selectedRows();
		var strstatus=0;
		if(rows.length == 0){ 
				alert('#springMessage("view.tms.pub.checkbox.msg0")!');
				return;
			}
		if(rows.length>1){
			alert('#springMessage("view.tms.pub.checkbox.msg1")!');
			return;
		}
	    $.each(rows, function(i, row){
	    if(row['STATUS']==1)
	    {
	    	alert('#springMessage("view.tms.rule.check.user")!');
	    	strstatus=row['STATUS'];
			return;
	    }
	   });
	      if(strstatus!=1)
     {
		if(confirm('#springMessage("view.tms.pub.open.confirm")?')){
		
			var ruleId = [];
			$.each(rows, function(i, row){
				ruleId.push('ruleId='+row['RULEID']);
			});
			var params = ruleId.join('&');
			jcl.postJSON('/tms/rule/open', params, function(data){
				alert('#springMessage("view.tms.pub.operate.success")!');
				g.goPage();
			});
		}else{
			return ;
		}
		}
	});
	
	
	$("#btn-unused").click(function(){
	var rows = g.selectedRows();
	var status=1;
	if(rows.length == 0){ 
				alert('#springMessage("view.tms.pub.checkbox.msg0")!');
				return;
	}
   if(rows.length>1){
			alert('#springMessage("view.tms.pub.checkbox.msg1")!');
			return;
		}
	$.each(rows, function(i, row){
      if(row['STATUS']==0)
	    {
	    	alert('#springMessage("view.tms.rule.check.unuser")!');
	    	status=row['STATUS'];
			return;
	    }
     });
     if(status!=0)
     {
		if(confirm('#springMessage("view.tms.pub.close.confirm")?')){
			var ruleId = [];
			$.each(rows, function(i, row){
				ruleId.push('ruleId='+row['RULEID']);
			});
			var params = ruleId.join('&');
			jcl.postJSON('/tms/rule/close', params, function(data){
				alert('#springMessage("view.tms.pub.operate.success")!');
				g.goPage();
			});
		}else{
			return ;
		}
	}
	});
	jcl.code.selector('STATUS','tms.mgr.rulestatus',{text:'--请选择--',value:''});
	jcl.code.selector('DISPOSAL','tms.rule.disposal',{text:'--请选择--',value:''});
		
	jcl.postJSON('/tms/dp/txn/getAll', "", function(data){
		$.each(data.row, function(i,row){
			//$("select[name=TXNID]").append("<option value='" + row['K'] + "'>" + row['V'] + "</option>");  
			if(row['K'].indexOf('G')>-1){//如果是组或渠道，添加为optgroup属性，不能选择               
				$("select[name=TXNID]").append("<optgroup label='"+row['V']+"'> "+ row['V'] + "</optgroup>");
			}else{
				$("select[name=TXNID]").append("<option value='" + row['K'] + "'>" + row['V'] + "</option>");
			} 
		}); 
	});
	
});
</script>

</head>
<body>

<div id="boxdiv" class="box"></div>
<form id="qform" name="qform">
<input style="display: none"/>
   <table>
       <tr>
           <td width="10%"align='center'>#springMessage("view.tms.rule.add.rulename")</td>
           <td width="15%">
               <input name="RULENAME" id="RULENAME" type="text" class="itext" value=""/>
           </td>
           <td width="10%"align='center'>#springMessage("view.tms.rule.add.status")</td>
           <td width="15%">
            <select id="STATUS" name="STATUS">
               </select>
           </td>
           <td width="10%"align='center'>#springMessage("view.tms.rule.add.trade")</td>
           <td width="15%"> 
			<select id="TXNID" name="TXNID">
                     <option value="">--请选择--</option>
			</select>
           </td>
		   <td width="10%" align='center'>#springMessage("view.tms.rule.add.disposal")</td>
           <td width="15%"> 
			<select id="DISPOSAL" name="DISPOSAL">
                     <option value="">--请选择--</option>
			</select>
           </td>
           <td  align="center"><input id="quick_search_btn" type="button" value="#springMessage('ui.common.btn.qquery')" class="btn"/></td>
       </tr>

	</table>
</form>

</body>
</html>
