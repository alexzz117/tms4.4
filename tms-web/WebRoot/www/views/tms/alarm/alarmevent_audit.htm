<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>#springMessage("view.tms.alarm.audit.title")</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms35/js/commoncheck.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.url.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/validate.js"></script>
<style type="text/css">
.form-item-label {
	display: block;
	float: left;
	line-height: 26px;
	padding-right: 10px;
	text-align: right;
	width: 70px;
}
</style>
<script type="text/javascript">
	var txnCode = jQuery.url.param('txnCode');
	$(document).ready(function() {
		var psBox = new jcl.ui.Box({
			title : '#springMessage("view.tms.alarm.audit.title")'
		});

		// 欺诈类型、处理信息Form
		var psForm = new jcl.ui.Form({
			display : true,
			layout : 'list',
			items : [ {
				label : '#springMessage("view.tms.alarm.process.fraudtype")',
				name : 'FRAUD_TYPE',
				type : 'selector',
				items : [ {
					text : '--请选择--',
					value : ''
				} ],
				ds : {
					type : 'code',
					category : 'tms.alarm.fraudtype'
				},
				required : true
			}, {
				label : '#springMessage("view.tms.alarm.audit.result")',
				name : 'PS_RESULT',
				type : 'radio',
				items : [ {
					text : '通过',
					value : '1',
					checked : true
				}, {
					text : '未通过',
					value : '0'
				} ],
				required : true
			}, {
				label : '#springMessage("view.tms.alarm.audit.info")',
				name : 'PS_INFO',
				type : 'textarea'
			} ],
			btns : [ {
				id : 'ps_sure',
				text : '#springMessage("view.tms.pub.btn.sure")'
			}, {
				id : 'ps_cancel',
				text : '#springMessage("view.tms.pub.btn.cancel")'
			} ]
		}, psBox.container);
		psForm.jqDom.find('li.form-item:eq(0)').after('<li class="form-item" style="width: 100%;"></li>');
		var gridBox = psForm.jqDom.find('li.form-item:eq(1)');
		// 处理动作列表
		var psActionGrid = new jcl.ui.Grid({
			title : '#springMessage("view.tms.alarm.process.action.list")',
			marginTop : 0,
			table : {
				checkboxEnable : false,
				columns : [ {
					name : '#springMessage("view.tms.alarm.process.action.name")',
					width : 35,
					dataIndex : 'AC_NAME'
				}, {
					name : '#springMessage("view.tms.alarm.process.action.cond")',
					width : 35,
					dataIndex : 'AC_COND_IN'
				}, {
					name : '#springMessage("view.tms.alarm.process.action.expr")',
					width : 35,
					dataIndex : 'AC_EXPR_IN'
				} ],
				pagebar : false
			}
		}, gridBox);

		var psInfoGrid = new jcl.ui.Grid({
			title : '#springMessage("view.tms.alarm.process.info.list")',
			marginTop : 0,
			table : {
				checkboxEnable : false,
				columns : [ {
					name : '#springMessage("view.tms.alarm.process.info.time")',
					width : 35,
					dataIndex : 'PS_TIME'
				}, {
					name : '#springMessage("view.tms.alarm.process.info.type")',
					width : 35,
					dataIndex : 'PS_TYPE',
					render : 'tms.alarm.process.type'
				}, {
					name : '#springMessage("view.tms.alarm.process.info.oper")',
					width : 35,
					dataIndex : 'LOGIN_NAME'
				}, {
					name : '#springMessage("view.tms.alarm.process.info.result")',
					width : 35,
					dataIndex : 'PS_RESULT',
					render : 'tms.alarm.process.result'
				}, {
					name : '#springMessage("view.tms.alarm.process.info")',
					width : 35,
					dataIndex : 'PS_INFO'
				}, {
					name : '快捷动作',
					width : 35,
					dataIndex : 'SHORT_ACTION'
				} ],
				pagebar : false
			}
		}, gridBox);
		psInfoGrid.jqDom.css('padding-top', 8)
		params = [];
		params.push({
			name : 'TXN_CODE',
			value : txnCode
		});
		jcl.postJSON('/tms/alarmevent/audit', params, function(data) {
			var txn = data['txnMap'], acts = data['actList'], procs = data['psList'];
			if (txn) {
				psForm.getItem('FRAUD_TYPE').val(txn['FRAUD_TYPE']);
				var psStatus = txn['PSSTATUS'];
				if (!(psStatus == '03')) {
					disableView(psForm, psActionGrid, psInfoGrid);
				}
			}
			if (acts) {
				psActionGrid.renderPage({
					list : acts
				});
			}
			if (procs) {
				psInfoGrid.renderPage({
					list : procs
				});
			}
			psForm.disable('FRAUD_TYPE', true);
		}, false);
		var isSure = false;
		$("#ps_sure").click(function() {
			try {
				var this_btn = $(this);
				var ps_info = psForm.getItem('PS_INFO').val();
				//if (!IsEmpty(ps_info)) {
				//	throw '#springMessage("view.tms.alarm.audit.info")';
				//}
				if (!checkeLength(ps_info, 255)) {
					jcl.msg.error('#springMessage("view.tms.alarm.audit.info")' + '不能超过255字符');
					return;
				}
				var param = psForm.jqDom.serializeArray();
				param.push({
					name : 'PS_TYPE',
					value : '2'
				});
				param = param.concat(params);
				jcl.postJSON('/tms/alarmevent/saveAudit', param, function(data) {
					if (data.result == 1) {
						disableView(psForm, psActionGrid, psInfoGrid);
						isSure = true;
						jcl.msg.info('审核成功');
						window.returnValue = 1;
						window.close();
					} else {
						jcl.msg.info('审核失败');
					}
				});
			} catch (e) {
				jcl.msg.error(e + '不能为空');
			}
		});

		$("#ps_cancel").click(function() {
			if (isSure)
				window.returnValue = 1;
			window.close();
		});
	});
	function disableView(psForm, psActionGrid, psInfoGrid) {
		$("#ps_sure").hide();
		psForm.disable('PS_RESULT', true);
		psForm.disable('PS_INFO', true);
	}
</script>
</head>
<body>
</body>
</html>