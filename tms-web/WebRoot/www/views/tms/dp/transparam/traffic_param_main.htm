<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>#springMessage("view.tms.objversion.list")</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<link href="$rc.contextPath/s/common/css/tree.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms/js/commoncheck.js"></script>

<script type="text/javascript"  >
var contextPath;
$(document).ready(function(){
	var box = new jcl.ui.Box({
		title: '#springMessage("view.tms.objversion.list")',
		minWidth:800
	});
	box.addDom('func-box');
	
	jcl.postJSON('/tms/mgr/meta/versionlist', '', trVersion);
	//对交易的操作
	$('#addSubmitButton').click(addVersionSubmit);
	$('#modSubmitButton').click(addVersionSubmit);
	$('#cancelButton').click(cancel);//
	
});
function trVersion(data){
	contextPath = data.contextPath;
	var tabHtml = "";
	var versionlist= data.row;
	for(var i=0;i<versionlist.length;i++){
		tabHtml+='<tr><td>';
		tabHtml+='<input name="ck" type="checkbox" id="ck" value="'+versionlist[i]["VERSIONID"]+'" />';
		tabHtml+='</td><td align="left">';
		tabHtml+='<label  onclick="changeIframSrc(\''+versionlist[i]["VERSIONID"]+'\',\''+versionlist[i]["VERSIONNAME"]+'\')" style="cursor: pointer;">';
		tabHtml+=versionlist[i]["VERSIONNAME"]+'</label>';
		tabHtml+='</td></tr>';
	}
	$('#tabVersionList').html(tabHtml);
}
//显示新建界面
function newVersion(){
	$("#version_Id").val('');
	$("#version_name").val('');
	$("#info").val('');
	$("#version_number").val('');
	$("#optcode").val(0);

	$('#addSubmitButton').show();
	$('#modSubmitButton').hide();
	$('#form-txn-box').show();
	$('#ifram-box').hide();
}
//显示修改页面
function editVersion(){
	var ck  = document.getElementsByName("ck");
	var count=0;
	
	$("#optcode").val(1);
	
	for(var i=0;i<ck.length;i++){
		if(ck[i].checked){
			versionId="versionId="+ck[i].value;
			count++;
		}
	}
	if(count<1){
		alert('#springMessage("view.tms.pub.checkbox.msg0")');
		return;
	}
	if(count>1){
		alert('#springMessage("view.tms.pub.checkbox.msg1")');
		return;
	}
	//根据Id查询相应信息
	jcl.postJSON('/tms/mgr/meta/getVersion', versionId, function(data){
		var row = data.row;
		$("#version_Id").val(row["VERSIONID"]);
		$("#version_name").val(row["VERSIONNAME"]);
		$("#info").val(row["VERSIONDESC"]);
		$("#version_number").val(row["VERSIONNO"]);
		
		//$('input:radio[name=status]').each(function(){
		//	if (row["STATUS"] == $(this).val()){
		//		$(this).attr('checked', true);
		//	}else{
		//		$(this).attr('checked', false);
		//	}
		//});
		
		$('#addSubmitButton').hide();
		$('#modSubmitButton').show();
		$('#form-txn-box').show();
		$('#ifram-box').hide();
	});

}
//隐藏所有界面
function cancel(){
	$('#form-txn-box').hide();
	$('#ifram-box').hide();
}
//新增/修改版本信息
function addVersionSubmit(){
	
	var optcode = $("#optcode").val();
	var versionname = $("#version_name").val();
	//var versionNum = $("#version_number").val();
	var info = $("#info").val();
	
	if(versionname.trim()==''){
		alert('#springMessage("view.tms.objversion.namenotnull")！');
		return;
	}else {	
		var flag = checkeLength(versionname);
		if(!flag){
			alert('#springMessage("view.tms.objversion.nameLength")！');
			return;
		}
		flag = checkeSpecialCode(versionname);
		if(!flag){
			alert('#springMessage("view.tms.objversion.nameSpecialCode")！');
			return;
		}
	}
	
	if(info.trim()!=''){
		var flag = checkeLength(info,256);
		if(!flag){
			alert('描述信息超长');
			return;
		}
		flag = checkeSpecialCode(info);
		if(!flag){
			alert('描述信息含有特殊字符');
			return;
		}
	}
	
	var r   =   /^\+?[1-9][0-9]*$/;　　//正整数     		
	/*if(versionNum==''){
		alert('#springMessage("view.tms.objversion.numnotnull")！');
		return;
	}else if(versionNum.length>4){
		alert('版本号不能大于4位数');
		return;
	}else if(!r.test(versionNum)){
		alert('#springMessage("view.tms.objversion.numnotnegnum")');
		return;
	}*/
	
	$("#version_name").val(versionname.trim());
	var param = $('#data-form').serializeArray();
	if(optcode!=null && optcode=='0'){
		jcl.postJSON('/tms/mgr/meta/addVersion', param, function(data){
			if(data.success){
				alert('#springMessage("view.tms.pub.operate.success")！');
				jcl.go("/tms/mgr/meta/versionlist");
			}
		});
	}else if(optcode!=null && optcode=='1'){
		jcl.postJSON('/tms/mgr/meta/modVersion', param, function(data){
			if(data.success){
				alert('#springMessage("view.tms.pub.operate.success")！');
				jcl.go("/tms/mgr/meta/versionlist");
			}
		});
	}
}
//修改版本信息
function modVersionSubmit(){
	
}
//删除版本信息
function delVersion(){
	var versionId='';
	var count=0;
	var ck  = document.getElementsByName("ck");
	for(var i=0;i<ck.length;i++){
		if(ck[i].checked){
			count++;
			versionId+="versionId="+ck[i].value+"&";
		}
	}
	
	if(count>1){
		alert('#springMessage("view.tms.pub.checkbox.msg1")');
		return;
	}
	if(versionId!=''){
		if(confirm('#springMessage("view.tms.pub.del.confirm")？')){
			versionId=versionId.substring(0,versionId.length-1);
			jcl.postJSON('/tms/mgr/meta/delVersion', versionId, function(data){
				if(data.success){
					alert('#springMessage("view.tms.pub.del.success")！');
					jcl.go("/tms/mgr/meta/versionlist");
				}
			});
		}
	}else{
		alert('#springMessage("view.tms.pub.checkbox.msg0")');
		return; 
	}
}
//全选/取消全选
function checkedAll(obj){
	if(obj.checked){
		$("input[name='ck']").attr("checked", true);
	}else{
		$("input[name='ck']").removeAttr("checked");//取消全选 
	}

}

function changeIframSrc(versionId,versionName){
	var ifram = document.getElementById("iframId");	
	ifram.src=contextPath+"/tms/mgr/meta/objlist?versionId="+versionId+"&versionName="+versionName;	
	$('#form-txn-box').hide();
	$('#ifram-box').show();
}

</script>

</head>
<body>

<table id="func-box">
	<tr>
		<td width="320" valign="top" style="border-right: 1px solid #B2B2B2;" id="leftTd1" >
			<div id="version-box" style="width:225px;">
				<table >
					<tr >
						<td width="25%">
						<input name="allck" type="checkbox" id="allck" onclick="checkedAll(this)"/>#springMessage("view.tms.pub.btn.checkeall")
						</td>
						<td width="7%">
						<span title="新建"  class="box-toolbar-item-icon icon icon-tb-add"></span>
						</td>
						<td width="15%">
						<label  style="cursor: pointer;" onclick="newVersion()">#springMessage("view.tms.pub.btn.new")</label>  
						</td>
						<td width="7%">
						<span title="编辑"  class="box-toolbar-item-icon icon icon-tb-edit"></span>
						</td>
						<td width="15%">
						<label onclick="editVersion()" style="cursor: pointer;">#springMessage("view.tms.pub.btn.edit")</label>  
						</td>
						<td width="7%">
						<span title="删除"  class="box-toolbar-item-icon icon icon-tb-del"></span>
						</td>
						<td width="15%">
						<label onclick="delVersion()" style="cursor: pointer;">#springMessage("view.tms.pub.btn.del")</label> 
						</td>
					</tr>
				</table>
					<hr />
				<table id="tabVersionList" >
					
				</table>
			</div>
		</td>
		<td valign="top" width="90%"> 
		<div id="ifram-box" style="display:none;"style="width:100%;"> 
			<iframe frameborder="0" scrolling="auto" width="100%" height="550px" style="border: hidden" name="iframbox" id="iframId" ></iframe>
		</div>
			
		<div id="form-txn-box" style="display:none; width:100%;">
			<form name="data-form" id="data-form" method="post">
			<input style="display:none" />
				<ul class="list-box">
					<li class="list-box-item">
						<input name="optcode" type="hidden" value="" class="itext" id="optcode" />
						<input name="version_Id" type="hidden" class="itext" id="version_Id" />
						<label class="list-box-item-label" for="">#springMessage("view.tms.objversion.name")：</label> 
						<span class="list-box-item-content">
						<input name="version_name" type="text" class="itext" id="version_name" /><font color="red">*</font>
						</span></li>
					<li class="list-box-item">
						<label class="list-box-item-label" for="">#springMessage("view.tms.objversion.info")：</label> 
						<span class="list-box-item-content"><textarea name="info" class="ttext" id="info" ></textarea></span></li>
							
					<!--<li class="list-box-item">
						<label class="list-box-item-label" for="">#springMessage("view.tms.objversion.number")：</label> 
						<span class="list-box-item-content">
						<input name="version_number" type="text" class="itext" id="version_number" /><font color="red">*</font>
						</span>
						<input name="status" type="hidden" class="itext" id="status" value="1"/>
					</li>-->
				<!-- 
					<li class="list-box-item" id="item-menu">
						<label class="list-box-item-label" for="">是否启用：</label> 
						<span class="list-box-item-content">
							<input type="radio" name="status" value="0"   checked="checked"/> 否
							<input type="radio" name="status" value="1"  /> 是
						</span></li>
				 -->
				 <input name="status" type="hidden" class="itext" id="status" value="1"/>
				</ul>
		        
				<div class="button-box">
					<input type="button" value='#springMessage("view.tms.pub.btn.save")' class="btn" id="addSubmitButton"/>
					<input type="button" value='#springMessage("view.tms.pub.btn.mod")' class="btn" id="modSubmitButton"/>
					<input type="button" value='#springMessage("view.tms.pub.btn.cancel")' class="btn" id="cancelButton"/>
				</div>
			</form>
		</div>
			
			
		</td>
	</tr>
</table>

</body>
</html>
