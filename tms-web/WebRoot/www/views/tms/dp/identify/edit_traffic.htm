<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>#springMessage("view.tms.traffic.editinfo")</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<link href="$rc.contextPath/s/common/css/tree.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.url.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms/js/commoncheck.js"></script>

<script type="text/javascript">
$(document).ready(function(){
	
	var txnId = "txnId="+jQuery.url.param("txnId");
	var optype = jQuery.url.param("optype");
	var title = "";
	if(optype=="edit"){
		title='#springMessage("view.tms.traffic.editinfo")';
	}else{
		title='#springMessage("view.tms.traffic.copyinfo")';
	}
	
	var box = new jcl.ui.Box({
		title: title,
		id:'addRoleFormBox',
		minWidth:490
	});
	box.addDom('dataForm');
	
	if(optype=="edit"){
		$('#txncopyTxnSubmitButton').hide();
		$('#txnmodTxnSubmitButton').show();
	}else{
		$('#txncopyTxnSubmitButton').show();
		$('#txnmodTxnSubmitButton').hide();
		$('#confinfo').hide();		
	}
	jcl.code.selector('txntype','tms.common.txntype',{text:'--请选择--',value:''});
	var param = txnId+"&oper=temp";
	jcl.postJSON('/tms/dp/txn/get', param, function(data){
			
	      if(optype=="edit"){
			$('#txnfid').val(data.row.TXNID);
		}else{
			$('#txnfid').val('');
			$('#copyTxnId').val(data.row.TXNID);			
		}
		$('#txnffid').val(data.row.TXNGROUPID);
		$('#txnchannelid').val(data.row.CHANNELID);
		if(optype=="edit"){
			$('#txnfname').val(data.row.TXNNAME);
		}else{
			$('#txnfname').val("复制_"+data.row.TXNNAME);
		}
		
		$('#txninfo').val(data.row.TXNDESC);
		$('#txnffname').val(data.row.PARENTNAME);
		$('#WEIGHT').val(data.row.WEIGHT);
		$('#ORDERBY').val(data.row.ORDERBY);
		
		$('#txntype').val(data.row.TXNTYPE);
		
		
		$('input:radio[name=status]').each(function(){
		if (data.row.STATUS == '0'){
			$('#status1').attr('checked', true);
		}else{
			$('#status2').attr('checked', true);
		}
		});
					
		$('#config1').text(data.row.CONFIG1);
		$('#config2').text(data.row.CONFIG2);
		 
		var versionlist = data.versionlist;
				
		
		var htmlStr ='';
		for(var i=0;versionlist!=null&&i<versionlist.length;i++){ 
			if(data.row.VERSIONID==versionlist[i]['VERSIONID']){
				htmlStr+='<input name="txnversion" type="hidden" value="'+versionlist[i]['VERSIONID']+'" id="txnversion" />';
				htmlStr+=versionlist[i]['VERSIONNAME'];
			}
		}
		$('#spanversion').html(htmlStr);		
			
	});
	
	var dialog = jcl.ui.Dialog({
		title:'#springMessage("view.cmc.pub.dialog.title")'
	});
	dialog.addDom('succesInfo');
	
	$("#txnmodTxnSubmitButton").click(function(){	
		var txnfname = $('#txnfname').val();
		var txnversion = $('#txnversion').val();
		
		var txninfo = $('#txninfo').val();
		var WEIGHT = $('#WEIGHT').val();		
		var ORDERBY = $('#ORDERBY').val();
		var txntype = $('#txntype').val();
		
		if(txnfname.trim()==''){
			alert('#springMessage("ui.tms.traffic.empty")');
			return ;
		}else {
			var flag = checkeLength(txnfname);
			if(!flag){
				alert('#springMessage("view.tms.traffic.nameTooLong")');
				return;
			}
			flag = checkeSpecialCode(txnfname);
			if(!flag){
				alert('#springMessage("view.tms.traffic.nameContainSpeCode")');
				return;
			}
		}
		if(txninfo.trim()!=''){
			var flag = checkeSpecialCode(txninfo);
			if(!flag){
				alert('#springMessage("view.tms.traffic.infoContainSpeCode")');
				return;
			}
			flag = checkeLength(txninfo,'256');
			if(!flag){
				alert('#springMessage("view.tms.traffic.infoTooLong")');
				return;
			}
		}
		if(WEIGHT!=''){
			var r   =    /^\d*$/;　　//非负整数   
			if(!r.test(WEIGHT) || WEIGHT<0 || WEIGHT>100){
				alert('#springMessage("view.tms.traffic.weightType")');
				return;
			}
		}else{
			alert('#springMessage("view.tms.traffic.weightEmpty")');
			return;
		}  
		if(ORDERBY!=''){
			var r   =    /^\d*$/;　　//非负整数   
			if(!r.test(ORDERBY)){
				alert('#springMessage("view.tms.traffic.orderType")');
				return;
			}
			var flag = checkeLength(ORDERBY,'4');
			if(!flag){
				alert('#springMessage("view.tms.traffic.orderToLong")');
				return;
			}
		}
		if(txntype==''){
			alert('#springMessage("view.tms.traffic.txnTypeEmpty")');
			return ;
		}
		
		var params = $('#dataForm').serialize();
		jcl.postJSON('/tms/dp/txn/mod', params, function(data){
			if(data.success){
				$('#copyinfo').hide();
				dialog.show();
			}
		});
			
	})
	$("#txncopyTxnSubmitButton").click(function(){	
		var txnfname = $('#txnfname').val();
		 
		var txninfo = $('#txninfo').val();
		var WEIGHT = $('#WEIGHT').val();
		var ORDERBY = $('#ORDERBY').val();
		var txntype = $('#txntype').val();
				
		if(txnfname.trim()==''){
			alert('#springMessage("ui.tms.traffic.empty")');
			return ;
		}else {
			var flag = checkeLength(txnfname);
			if(!flag){
				alert('#springMessage("view.tms.traffic.nameTooLong")');
				return;
			}
			flag = checkeSpecialCode(txnfname);
			if(!flag){
				alert('#springMessage("view.tms.traffic.nameContainSpeCode")');
				return;
			}
		}
		
		if(txninfo.trim()!=''){
			var flag = checkeSpecialCode(txninfo);
			if(!flag){
				alert('#springMessage("view.tms.traffic.infoContainSpeCode")');
				return;
			}
			flag = checkeLength(txninfo,'256');
			if(!flag){
				alert('#springMessage("view.tms.traffic.infoTooLong")');
				return;
			}
		}
		if(WEIGHT!=''){
			var r   =    /^\d*$/;　　//非负整数   
			if(!r.test(WEIGHT) || WEIGHT<0 || WEIGHT>100){
				alert('#springMessage("view.tms.traffic.weightType")');
				return;
			}
		}else{
			alert('#springMessage("view.tms.traffic.weightEmpty")');
			return;
		}  
		if(ORDERBY!=''){
			var r   =    /^\d*$/;　　//非负整数   
			if(!r.test(ORDERBY)){
				alert('#springMessage("view.tms.traffic.orderType")');
				return;
			}
			var flag = checkeLength(ORDERBY,'4');
			if(!flag){
				alert('#springMessage("view.tms.traffic.orderToLong")');
				return;
			}
		}
		if(txntype==''){
			alert('#springMessage("view.tms.traffic.txnTypeEmpty")');
			return ;
		}
		
		$('#txnfname').val(txnfname.trim());
		var params = $('#dataForm').serialize();
		jcl.postJSON('/tms/dp/txn/copy', params, function(data){
			if(data.success){
				$('#oprinfo').hide();
				dialog.show();
			}
		});				
	})
	
	
	$('#txncancelButton').click(function(){
		//jcl.go('/tms/dp/txn/edit');
		window.parent.document.getElementById("ifram-box").style.display="none";
	});
	$('#backBtn').click(function(){
		window.parent.location.href=window.parent.location.href;
	});
});

function mark(){
	var weight=$('#WEIGHT').val();
	if(weight==0){
		$('#mark').show();
	}else{
		$('#mark').hide();
	}
}

</script>

</head>
<body>

<div id="succesInfo" style="width:300px;" >
	<div id="oprinfo">#springMessage("view.tms.pub.edit.success")</div>
	<div id="copyinfo">#springMessage("view.tms.traffic.copysuccess")</div>
	<div class="button-box">
		<input type="button" value='#springMessage("view.cmc.pub.btn.sure")' class="btn" id="backBtn"/>
	</div>
</div>

<div id="form-txn-box" style="width:480px;">
	<form name="dataForm" id="dataForm" method="post">
	<ul class="list-box">
		<li>#springMessage("view.tms.traffic.info")</li>
	</ul>
	<hr />
	<input name="txnfid" type="hidden" id="txnfid" />
	<input name="parent_id" type="hidden" id="txnffid" />
	<input name="channelid" type="hidden" id="txnchannelid" />
	<input name="oper" type="hidden" id="oper" value="temp" />
	<!-- 用于复制交易时使用 -->
	<input name="copyTxnId" type="hidden" id="copyTxnId" />
	
	<ul class="list-box">
		<li class="list-box-item">
			<label class="list-box-item-label" for="txnfname">#springMessage("view.tms.traffic.name")：</label> 
			<span class="list-box-item-content">
			<input name="txn_name" type="text" class="itext" id="txnfname" /><font color="red">*</font>
			</span></li>
		<li class="list-box-item">
			<label class="list-box-item-label" for="info">#springMessage("view.tms.traffic.groupdesc")：</label> 
			<span class="list-box-item-content"><textarea name="txninfo" class="ttext" id="txninfo" ></textarea></span></li>
							
		<li class="list-box-item">
			<label class="list-box-item-label" for="txnffname">#springMessage("view.tms.traffic.groupparent")：</label> 
			<span class="list-box-item-content">
				<input name="ffname" type="text" class="itext" id="txnffname" disabled="disabled"/>
			</span></li>
			
		<li class="list-box-item">
			<label class="list-box-item-label" for="txnversion">#springMessage("view.tms.traffic.version")：</label> 
			 
			<span class="list-box-item-content" id="spanversion"> </span>
		</li>
		<li class="list-box-item">
			<label class="list-box-item-label" for="onum">#springMessage("view.tms.traffic.weight")：</label> 
			<span class="list-box-item-content">
			<input name="WEIGHT" type="text"  class="itext short" id="WEIGHT" onblur="mark()" />%<font color="red">*</font>
			<label id="mark" style="display: none;color: red;" >#springMessage("view.tms.traffic.weightMark")</label>
			</span>
		</li>				
		<li class="list-box-item">
			<label class="list-box-item-label" for="onum">#springMessage("view.tms.traffic.grouporder")：</label> 
			<span class="list-box-item-content"><input name="ORDERBY" type="text" class="itext short" id="ORDERBY" /></span>
		</li>
		
		<li class="list-box-item" id="item-menu">
			<label class="list-box-item-label" for="txntype">#springMessage("view.tms.traffic.fundstraffic")：</label> 
			<span class="list-box-item-content">
				<select name="txntype" id="txntype" style="width: 100px" >
				</select><font color="red">*</font>
				<!-- 
				<input type="radio" name="txntype" value="1" checked="checked"/>  #springMessage("view.tms.pub.flag.false")
				<input type="radio" name="txntype" value="2" />  #springMessage("view.tms.pub.flag.true")
				 -->
			</span>
		</li>
		<li class="list-box-item" id="item-menu">
			<label class="list-box-item-label" for="txnstatus">#springMessage("view.tms.pub.btn.isused")：</label> 
			<span class="list-box-item-content">
				<input type="radio" name="status" value="0" id="status1" /> #springMessage("view.tms.pub.flag.false")
				<input type="radio" name="status" value="1" id="status2"/> #springMessage("view.tms.pub.flag.true")
			</span>
		</li>
	</ul>
       
	<div class="button-box">
		<input type="button" value='#springMessage("view.tms.pub.btn.save")' class="btn" id="txnmodTxnSubmitButton"/>
		<input type="button" value='#springMessage("view.tms.pub.btn.copy")' class="btn" id="txncopyTxnSubmitButton"/>
		<input type="button" value='#springMessage("view.tms.pub.btn.cancel")' class="btn" id="txncancelButton"/>
	</div>
	
	<div id="confinfo"  >
	<ul class="list-box">
		<li>#springMessage("view.tms.traffic.configinfo")</li>
	</ul>
	<hr />
	
	<table width="100%"   id="conftab" border="1" align="center" style="border-collapse: collapse;">
		<tr >
			<td width="15%" valign="middle" colspan="3" align="center">
				#springMessage("view.tms.traffic.featureConfig")：
			</td>
			<td width="80%" valign="top"   align="left" id="config1">
			</td>
		</tr>
		<tr  bgcolor="#EDEDED">
			<td width="15%" valign="middle" colspan="3" align="center">
				#springMessage("view.tms.traffic.tranConfig")：
			</td>
			<td width="80%" valign="top"   align="left" id="config2">
			</td>
		</tr>
	</table>
	
	</div>
	</form>
	
</div>

</body>
</html>
