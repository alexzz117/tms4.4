<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>#springMessage("view.tms.dp.pattern.add.title")</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms/js/commoncheck.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script> 
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<script type="text/javascript">
$(document).ready(function(){
	
	var box = new jcl.ui.Box({
		title: '#springMessage("view.tms.dp.pattern.add.title")',
		id:'addPatternFormBox'
	});
	box.addDom('dataForm');
	
	var dialog = jcl.ui.Dialog({
		title:'#springMessage("view.tms.pub.dialog.title")'
	});
	dialog.addDom('succesInfo');
	
	$("#addBtn").click(function(){
		var patternName=$('input[name=patternName]').val();
		var patternDsc =$('#patternDesc').val();
		if(patternName==""){
			alert('#springMessage("view.tms.dp.pattern.name.check")');
			return ;
		}
		if(!checkeLength(patternName, '')) {
			alert('#springMessage("view.tms.dp.pattern.name.check3")');
			return ;	
		}
		if(!checkeSpecialCode(patternName)) {
			alert('#springMessage("view.tms.dp.pattern.name.check2")');
			return ;	
		}
		if(!checkeLength(patternDsc, '256')) {
			alert('#springMessage("view.tms.dp.pattern.desc.checkLength")');
			return ;	
		}
		if(!checkeSpecialCode(patternDsc)) {
			alert('#springMessage("view.tms.dp.pattern.desc.specialCode")');
			return ;	
		}
		
		
		var txnid=$('select[id=txnid]').val();
		if(txnid==""){
			alert('#springMessage("view.tms.dp.pattern.txnid.check")');
			return ;
		}
		if(txnid=="Gnull"){
			alert('#springMessage("view.tms.dp.pattern.txnid.checknull")');
			return ;
		}
		
		var conds = "txnId="+txnid;
		jcl.postJSON('/tms/dp/pattern/checkExist', conds, function(data){
			if (data.row == "true") {
				alert("交易"+ $("#txnId").find("option:selected").text() +"不能重复配置,一个交易暂支持配置一个行为模式.");
				
				$('#txnid option:first').attr('selected','selected'); 
				return;
			}
			var params = $('#dataForm').serialize();
			jcl.postJSON('/tms/dp/pattern/add', params, function(data){
				dialog.show();
			});
	});
		
	});
	jcl.postJSON('/tms/dp/txnView/getAll', "", function(data){
		$.each(data.row, function(i,row){
			if(row['K'].indexOf('G')>-1){//如果是组或渠道，添加为optgroup属性，不能选择               
				$("select[name=txnid]").append("<optgroup label='"+row['V']+"'> "+ row['V'] + "</optgroup>");
			}else{
				$("select[name=txnid]").append("<option value='" + row['K'] + "'>" + row['V'] + "</option>");
			} 
			//$("select[name=txnid]").append("<option value='" + row['K'] + "'>" + row['V'] + "</option>");  
		}); 
	});
	$('#cancelBtn').click(function(){
		jcl.go('/tms/dp/pattern/list');
	});
	$('#goonBtn').click(function(){
		jcl.go('/tms/dp/pattern/add');
	});
	$('#backBtn').click(function(){
		jcl.go('/tms/dp/pattern/list');
	});
	
});
function txnChange(obj) {
	var txnId = $("#txnid").find("option:selected").val();
	if(txnId=="" || txnId=="null"){
				return ;
	}
	var conds = "txnId="+txnId;
	
	jcl.postJSON('/tms/dp/pattern/checkExist', conds, function(data){
			if (data.row == "true") {
				alert("交易"+ $("#txnid").find("option:selected").text() +"不能重复配置,一个交易暂支持配置一个行为模式.");				
				$('#txnid option:first').attr('selected','selected'); 
				return;
			}
	});
}
</script>

</head>
<body>
<div id="succesInfo">
	<div>#springMessage("view.tms.pub.add.success")</div>
	<div class="button-box">
		<input type='button' value='#springMessage("view.tms.pub.btn.continueCrt")' class='btn' id='goonBtn'/>
		<input type='button' value='#springMessage("view.tms.pub.btn.banck")' class='btn' id='backBtn'/>
	</div>
</div>


<form name="dataForm" id="dataForm" method="post">
<ul class="list-box">
	<li class="list-box-item">
		<label class="list-box-item-label">#springMessage("view.tms.dp.pattern.name")：</label> 
		<span class="list-box-item-content"><input name="patternName" type="text" class="itext"/><font color="red">*</font>
		</span>
	</li>
	<li class="list-box-item">
		<label class="list-box-item-label">#springMessage("view.tms.dp.pattern.desc")：</label> 
		<span class="list-box-item-content">
		<textarea name="patternDesc" class="ttext" id="patternDesc" ></textarea>
		</span>
	</li>
	<li class="list-box-item">
		<label class="list-box-item-label">#springMessage("view.tms.dp.pattern.txnid")：</label> 
		<span class="list-box-item-content"> 
			<select id="txnid" name="txnid" onchange="txnChange(this)">
	         	<option value="">--请选择--</option>
	        </select><font color="red">*</font>
		</span>
	</li>
	<li class="list-box-item">
		<label class="list-box-item-label">#springMessage("view.tms.pub.btn.isused")：</label> 
		<span class="list-box-item-content">
	<input type="radio" name="status" value="1" /> 是
			<input type="radio" name="status" value="0" checked="checked" /> 否
 </span>
	</li>
	
	 <input   style= "display:none; "/>
</ul>
<div class="button-box">
	<input type='button' value='#springMessage("view.tms.pub.btn.save")' class='btn' id='addBtn'/>
	<input type='button' value='#springMessage("view.tms.pub.btn.cancel")' class='btn' id='cancelBtn'/>
</div>
</form>

</body>
</html>
