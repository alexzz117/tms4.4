<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>#springMessage("view.tms.dp.pattern.list.title")</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms/js/commoncheck.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<script type="text/javascript">
var g = "";
$(document).ready(function(){
	
	//组装表格
	 g = $("#boxdiv").grid({
		title:'#springMessage("view.tms.dp.pattern.list.title")',
		columns:[
			{name:'#springMessage("view.tms.dp.pattern.name")', width: 80, dataIndex:'PATTERNNAME'},
			{name:'#springMessage("view.tms.dp.pattern.txnname")', width: 50, dataIndex:'TXNNAME'},
			{name:'#springMessage("view.tms.pub.crdate")', width: 40, dataIndex:'CREATETIME'},
			{name:'#springMessage("view.tms.pub.update")', width: 40, dataIndex:'MODIFYTIME'},
			{name:'#springMessage("view.tms.pub.flag")', width: 20, dataIndex:'STATUS', render:'tms.common.used'}
		],
		ds:{
			url:"/tms/dp/pattern/list",
			params:{oper:'temp'}
		},
		toolbar:[
			{id:"btn-find", icon:"icon-tb-find", text:'#springMessage("view.tms.pub.btn.find")', toggleQform:true},
			{id:"btn-add", icon:"icon-tb-add", text:'#springMessage("view.tms.pub.btn.new")'},
			{id:"btn-edit", icon:"icon-tb-edit", text:'#springMessage("view.tms.pub.btn.edit")'},
			{id:"btn-del", icon:"icon-tb-del", text:'#springMessage("view.tms.pub.btn.del")'},
			{id:"btn-conf", icon:"icon-tb-edit", text:'#springMessage("view.tms.pub.btn.attr")'},
			{id:"btn-used", icon:"icon-tb-edit", text:'#springMessage("view.tms.pub.btn.used")'},
			{id:"btn-unused", icon:"icon-tb-edit", text:'#springMessage("view.tms.pub.btn.unused")'}
		],
		pagebar: true,
		qform: {id:"qform", display:false}

	});
	g.goPage();
	
	
	$("#quick_search_btn").click(function(){
		var patternName=$('input[name=PATTERNNAME]').val();
		
		if(!checkeSpecialCode(patternName)) {
			alert('#springMessage("view.tms.dp.pattern.name.check2")');
			return ;	
		}
	
		var params = $('#qform').serialize();
		g.setDsParams(params);
		g.goPage();
	});
	$("#btn-add").click(function(){
		jcl.go('/tms/dp/pattern/add');
	});
	
	$("#btn-conf").click(function(){
		var rows = g.selectedRows();
		if(rows.length == 0){ 
			alert('#springMessage("view.tms.pub.checkbox.msg0")');
			return;
		}
		if(rows.length>1){
			alert('#springMessage("view.tms.pub.checkbox.msg1")');
			return;
		}
		var patternId = [];
		var txnId = [];
		$.each(rows, function(i,row){
			patternId.push('patternId='+row['PATTERNID']);
		}); 
		
		jcl.go('/tms/dp/pattern/attr/listTemp?' + patternId[0]);
	});
	
	$("#btn-edit").click(function(){
		var rows = g.selectedRows();
		if(rows.length == 0){ 
			alert('#springMessage("view.tms.pub.checkbox.msg0")');
			return;
		}
		if(rows.length>1){
			alert('#springMessage("view.tms.pub.checkbox.msg1")');
			return;
		}
		var patternId = [];
		$.each(rows, function(i,row){
			patternId.push('patternId=' + row['PATTERNID']);
		});            
		jcl.go('/tms/dp/pattern/editTemp?' + patternId[0]);
	});
	
	jcl.postJSON('/tms/dp/txnView/getAll', "", function(data){
		$.each(data.row, function(i,row){
			if(row['K'].indexOf('G')>-1){//如果是组或渠道，添加为optgroup属性，不能选择               
			$("select[name=TXNID]").append("<optgroup label='"+row['V']+"'> "+ row['V'] + "</optgroup>");
			}else{
			$("select[name=TXNID]").append("<option value='" + row['K'] + "'>" + row['V'] + "</option>");
			}  
		}); 
	});
	
	$("#btn-del").click(function(){
		//TODO: 安全起见，应逐条删除
		var rows = g.selectedRows();
		if(rows.length == 0){ 
			alert('#springMessage("view.tms.pub.checkbox.msg0")!');
			return;
		}
		/*if(rows.length>1){
			alert('#springMessage("view.tms.pub.checkbox.msg1")');
			return;
		}*/
		if(confirm('#springMessage("view.tms.pub.del.confirm")')){
			var patternId = [];
			$.each(rows, function(i, row){
				patternId.push('patternId='+row['PATTERNID']);
			});
			var params = patternId.join('&');
			jcl.postJSON('/tms/dp/pattern/del', params, function(data){
				alert('#springMessage("view.tms.pub.del.success")');
				g.goPage();
			});
		}else{
			return ;
		}
	});
	
	$("#btn-used").click(function(){
		var rows = g.selectedRows();
	
		if(rows.length == 0){ 
			alert('#springMessage("view.tms.pub.checkbox.msg0")!');
			return;
		}
		
		var patternId = []; 
		var flag = 0;
		$.each(rows, function(i, row){
			if(row['STATUS'] == 1) {
				flag = 1;
				return false;
			}
			patternId.push('patternId='+row['PATTERNID']);
		});
		if (flag == 1 && rows.length > 1) {
			alert('#springMessage("view.tms.pub.moreopened")!');
			return ;
		}
		if (flag == 1 && rows.length == 1) {
			alert('#springMessage("view.tms.pub.opened")!');
			return ;
		}
		if(confirm('#springMessage("view.tms.pub.open.confirm")')){
			var params = patternId.join('&');
			jcl.postJSON('/tms/dp/pattern/open', params, function(data){
				alert('#springMessage("view.tms.pub.operate.success")');
				g.goPage();
			});
		}else{
			return ;
		}
	});
	
	$("#btn-unused").click(function(){ 
	
		var rows = g.selectedRows();
		if(rows.length == 0){ 
			alert('#springMessage("view.tms.pub.checkbox.msg0")!');
			return;
		}		
	
		var patternId = [];
		var flag = 0;
		$.each(rows, function(i, row){
			if(row['STATUS'] == 0) {
				flag = 1;
				return false;
			}
			
			patternId.push('patternId='+row['PATTERNID']);
		});
		 
		if (flag == 1 && rows.length > 1) {
			alert('#springMessage("view.tms.pub.moreclosed")!');
			return ;
		}
		if (flag == 1 && rows.length == 1) {
			alert('#springMessage("view.tms.pub.closed")!');
			return ;
		}
		if(confirm('#springMessage("view.tms.pub.close.confirm")')){
			var params = patternId.join('&');
			jcl.postJSON('/tms/dp/pattern/close', params, function(data){
				alert('#springMessage("view.tms.pub.operate.success")');
				g.goPage();
			});
		}else{
			return ;
		}
	});
	jcl.code.selector('STATUS','tms.common.used',{text:'--请选择--',value:''});
});
</script>

</head>
<body>

<div id="boxdiv" class="box"></div>

<form id="qform" name="qform">
<input style="display:none" />
   <table>
       <tr>
           <td width="150">#springMessage("view.tms.dp.pattern.name")</td>
           <td width="200">
               <input name="oper" id="oper" type="hidden" class="itext" value="temp" />
               <input name="PATTERNNAME" id="PATTERNNAME" type="text" class="itext" value=""/>
           </td>
           <td width="70">#springMessage("view.tms.pub.flag")</td>
           <td width="130">
               <select name="STATUS" id="STATUS">
               </select>
           </td>
          
           <td width="110">#springMessage("view.tms.dp.pattern.txnid")</td>
           <td width="120">
                <select name="TXNID" id="TXNID" style="width:100%">
                 <option value="">--请选择--</option>
               </select>
           </td>
           <td  align="center" width="200"><input id='quick_search_btn' type='button' value='#springMessage("ui.common.btn.qquery")' class='btn'/></td>
       </tr>
	</table>
</form>

</body>
</html>
