<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>#springMessage("view.tms.dp.pattern.attr.edit.title")</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms/js/common/jcl_tms.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms/js/commoncheck.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script> 
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.url.js"></script>
<script type="text/javascript">
var funInvoke = new jcl_tms.util.FuncInvoke({ 
		id:'funInvoke'
	});
$(document).ready(function(){
	var patternId = jQuery.url.param("patternId");
	$('#patternId').val(patternId);
	var box = new jcl.ui.Box({
		title: '#springMessage("view.tms.dp.pattern.attr.edit.title")',
		id:'editPatternAttrFormBox'
	});
	box.addDom('dataForm');
	
	var dialog = jcl.ui.Dialog({
		title:'#springMessage("view.tms.pub.dialog.title")'
	});
	dialog.addDom('succesInfo');
	
	$("#addBtn").click(function(){
		var opts = $("#txnFeatureId option").length;
		if (opts <=1) {
			alert('#springMessage("view.tms.dp.pattern.attr.txnfid.check2")');
			return ;
		}
		var txnFeatureId=$('select[id=txnFeatureId]').val();
		if(txnFeatureId==""){
			alert('#springMessage("view.tms.dp.pattern.attr.txnfid.check")');
			return ;
		}
		if(txnFeatureId=="null"){
			alert('#springMessage("view.tms.dp.pattern.attr.txnfid.checknull")');
			return ;
		}
		var desc = $("#desc").val();
		if(!checkeLength(desc, '256')) {
			alert('#springMessage("view.tms.dp.pattern.attr.desc.checkLength")');
			return ;	
		}
		if(!checkeSpecialCode(desc)) {
			alert('#springMessage("view.tms.dp.pattern.attr.desc.specialCode")');
			return ;	
		}
		
		var orderby=$('#orderBy').val();
		if(orderby==""){
			alert('#springMessage("view.tms.dp.pattern.attr.order.check")');
			return ;
		}else if(orderby.length>4){
			alert('#springMessage("view.tms.dp.pattern.attr.order.toolong")');
			return ;
		}
		var msg = funInvoke.checktype(orderby, "NumberType");
		if (msg != ""){
			alert('#springMessage("view.tms.pub.order")');
			return ;
		}
		var store=$('select[id=store]').val();
		if(store==""){
			alert('#springMessage("view.tms.dp.pattern.attr.store.check")');
			return ;
		}
		
		var func_0=$('select[id=func_0]').val();
		if(func_0==null || func_0==""){
			alert('#springMessage("view.tms.dp.pattern.attr.patternfun.check")');
			return ;
		}
		
		var propId = jQuery.url.param("patternPropId");
		var conds = "patternPropId="+propId+"&txnFeatureId=" + $("#txnFeatureId").find("option:selected").val()+"&patternId="+jQuery.url.param("patternId");
		var condsStore = "patternPropId="+propId+"&storeColumn=" + $("#store").find("option:selected").val()+"&patternId="+jQuery.url.param("patternId");
	
		jcl.postJSON('/tms/dp/pattern/attr/checkExist', conds, function(data){
			if (data.row == "true") {
				alert("交易属性"+ $("#txnFeatureId").find("option:selected").text() +"不能重复配置!");
				
				$('#txnFeatureId option:first').attr('selected','selected'); 
				return;
			}
			
			jcl.postJSON('/tms/dp/pattern/attr/checkStoreExist', condsStore, function(data){
				if (data.row == "true") {
					alert("存储字段"+ $("#store").find("option:selected").text() +"不能重复配置!");
					
					$('#store option:first').attr('selected','selected'); 
					return;
				}
				//处理json数据
				var msg = funInvoke.save("param_0");
				if (msg != '') {
					alert(msg);
					return;
				}
					
				$('#patternXml').text(funInvoke.getJson());
				var params = $('#dataForm').serialize();
				jcl.postJSON('/tms/dp/pattern/attr/mod', params, function(data){
					dialog.show();
				});
			});
				
		});
		
		
		
		
		
	});
	
	$('#backBtn').click(function(){
		jcl.go('/tms/dp/pattern/attr/listTemp?patternId=' +　patternId);
	});
	
	$('#cancelBtn').click(function(){
		jcl.go('/tms/dp/pattern/attr/listTemp?patternId=' +　patternId);
	});
	
	//初始化数据 
	$('#func_0').change(function(){funChange(0);}); 
	//jcl.postJSON('/tms/mgr/fun/getAll', "module=dp&feature=pattern", function(data){
	//		$.each(data.row, function(i,row){
	//			$("select[name=func_0]").append("<option value='" + row['FUNCID'] + "'>" + row['FUNCNAME'] + "</option>");  
	//		}); 
	//}); 
	//交易属性
	jcl.postJSON('/tms/dp/pattern/attr/listFeats', "patternId="+patternId, function(data){
			$.each(data.row, function(i,row){
				if(row['TXNFEATUREID']==null || row['TXNFEATUREID']=="" || row['TXNFEATUREID']=="null" ){//如果是组或渠道，添加为optgroup属性，不能选择               
					$("select[name=txnFeatureId]").append("<optgroup label='"+row['PROPNAME']+"'> "+ row['PROPNAME'] + "</optgroup>");
				}else{
					$("select[name=txnFeatureId]").append("<option datatype='" + row['DATATYPE'] + "' value='" + row['TXNFEATUREID'] + "'>" + row['PROPNAME'] + "</option>");
				}
				//$("select[name=txnFeatureId]").append("<option datatype='" + row['DATATYPE'] + "' value='" + row['TXNFEATUREID'] + "'>" + row['PROPNAME'] + "</option>");  
			}); 
	});
	
	jcl.postJSON('/tms/dp/pattern/attr/getColum', "datatype=", function(data){
			$.each(data.row, function(i,row){
				$("select[name=store]").append("<option value='" + row['PROPCODE'] + "'>" + row['PROPNAME'] + "</option>");  
		}); 
	});
	
	//初始化数据

	var patternPropId = "patternPropId="+jQuery.url.param("patternPropId");
	var param = patternPropId+'&oper=temp';
	jcl.postJSON('/tms/dp/pattern/attr/get', param, function(data){
			$('#patternPropId').val(data.row.PATTERNPROPID);
			$('#desc').val(data.row.PATTERNPROPDESC);
			$('#orderBy').val(data.row.ORDERBY);
			//$('#store').val(data.row.STORECOLUMN);
			
			//jcl.postJSON('/tms/dp/pattern/attr/getColum', "datatype=" + datatype, function(data){
			//$.each(data.row, function(i,row){
			//	$("select[name=store]").append("<option value='" + row['PROPCODE'] + "'>" + row['PROPNAME'] + "</option>");  
			//}); 
			//});
			
			setTimeout(function() {
				$("#store").attr("value",data.row.STORECOLUMN);
			}, 500);
			$('#patternXml').val(data.row.GENERALPARAM);
			//radio设置value的值的项目为当前选中项
			//$("input[@name=status][value=" + data.row.STATUS + "]").attr("checked",true);
			var txnFeatureId = data.row.TXNFEATUREID;
			//select设置value的值的项目为当前选中项
			
			setTimeout(function() {
				$("#txnFeatureId").attr("value",txnFeatureId);
			}, 500);
			var func_0 = data.row.GENERALFUNCID;
			//select设置value的值的项目为当前选中项
			setTimeout(function() {
				$("#func_0").attr("value",func_0);
			}, 500);
			
			funInvoke.setJson(data.row.GENERALPARAM);
		
			jcl.postJSON('/tms/dp/pattern/attr/getDataType', 'txnFeatureId=' +txnFeatureId, function(data){
				var datatype = data.row;
				var condsStr = "model=dp&condition=pattern&functype="+datatype;
				jcl.postJSON('/tms/mgr/fun/funcList', condsStr, function(data){
					$.each(data.row, function(i,row){
						$("select[name=func_0]").append("<option value='" + row['FUNCID'] + "'>" + row['FUNCNAME'] + "</option>");  
					});
					funInvoke.show('param_0', "edit");
				});
			});
		});
});

//选择事件
function funChange(index) {
	var val = $('#func_' + index).val(); 
	if (val==null || val == "") {
		$('#param_' + index).html("");
		return;
	}
	jcl.postJSON('/tms/mgr/fun/getFunJson', "funId=" + val, function(data){
			funInvoke.setJson(data.row);
			$('#patternXml').text(data.row);
			funInvoke.show('param_0', "add");
	});
}
function txnParamChange(obj) {
	var datatype = $("#txnFeatureId").find("option:selected").attr("datatype");
	var condsStr = "model=dp&condition=pattern&functype="+datatype;
	var propId = jQuery.url.param("patternPropId");
	var txnFeatureId = $("#txnFeatureId").find("option:selected").val();
	if(txnFeatureId=="" || txnFeatureId=="null"){
			alert('#springMessage("view.tms.dp.pattern.attr.txnfid.check")');
			$('#txnFeatureId option:first').attr('selected','selected'); 
			return ;
	}
	var conds = "patternPropId="+propId+"&txnFeatureId=" + txnFeatureId+"&patternId="+jQuery.url.param("patternId");
	jcl.postJSON('/tms/dp/pattern/attr/checkExist', conds, function(data){
			if (data.row == "true") {
				alert("交易属性"+ $("#txnFeatureId").find("option:selected").text() +"不能重复配置!");
				$('#txnFeatureId option:first').attr('selected','selected'); 
				return;
			}
			jcl.postJSON('/tms/mgr/fun/funcList', condsStr, function(data){
			$("select[name=func_0]").empty();
			$('#param_0').html("");
			$("select[name=func_0]").append("<option value=\"\">--请选择--</option>"); 
			$.each(data.row, function(i,row){
				$("select[name=func_0]").append("<option value='" + row['FUNCID'] + "'>" + row['FUNCNAME'] + "</option>");  
			});
	});
	//jcl.postJSON('/tms/dp/pattern/attr/getColum', "datatype=" + datatype, function(data){
	//		$("select[name=store]").empty();
	//		$("select[name=store]").append("<option value=\"\">--请选择--</option>"); 
	///		$.each(data.row, function(i,row){
	//			$("select[name=store]").append("<option value='" + row['PROPCODE'] + "'>" + row['PROPNAME'] + "</option>");  
	//		}); 
	//});
	});
}
//
</script>

</head>
<body>
<div id="succesInfo">
	<div>#springMessage("view.cmc.pub.edit.success")</div>
	<div class="button-box">
		<input type="button" value='#springMessage("view.cmc.pub.btn.sure")' class="btn" id="backBtn"/>
	</div>
</div>

<div id="openDiv"></div>

<form name="dataForm" id="dataForm" method="post">
<ul class="list-box">
	<li class="list-box-item">
		<label class="list-box-item-label">#springMessage("view.tms.dp.pattern.attr.txnfid")：</label> 
		<span class="list-box-item-content"> <select id="txnFeatureId" name="txnFeatureId" onchange="txnParamChange(this)">
                     <option value="">--请选择--</option>
               </select><font color="red">*</font>
		</span>
	</li>
	<li class="list-box-item">
		<label class="list-box-item-label">#springMessage("view.tms.dp.pattern.attr.desc")：</label> 
		<span class="list-box-item-content">
		<textarea name="desc" class="ttext" id="desc" ></textarea></span>
	</li>
	
	<li class="list-box-item">
		<label class="list-box-item-label">#springMessage("view.tms.dp.pattern.attr.order")：</label> 
		<span class="list-box-item-content"><input id="orderBy" name="orderBy" type="text" class="itext"/><font color="red">*</font></span>
	</li>
	<li class="list-box-item">
		<label class="list-box-item-label">#springMessage("view.tms.dp.pattern.attr.store")：</label> 
		<span class="list-box-item-content">
			<select id="store" name="store">
                     <option value="">--请选择--</option>
               </select><font color="red">*</font>
		</span>
	</li>
	<li class="list-box-item">
		<label class="list-box-item-label">#springMessage("view.tms.dp.pattern.attr.patternfun")：<BR/>
		<input type="hidden" value="添加一行" class="btn" id="addFuncBtn"/></label> 
		<span id="addFuncSpan" class="list-box-item-content" style="display: inline;line-height: 26px">
		 	<div id="f_0" style="display: inline">
				<select id="func_0" name="func_0" index="0">
	                <option value="">--请选择--</option>
	            </select><font color="red">*</font>&nbsp;&nbsp;&nbsp;&nbsp;
	            <div id="param_0" style="display: inline"></div>
	        </div>
         </span>
	</li>
</ul>
<div class="button-box">
	
	<input type='button' value='#springMessage("view.tms.pub.btn.save")' class='btn' id='addBtn'/>
	<input type='button' value='#springMessage("view.tms.pub.btn.banck")' class='btn' id='cancelBtn'/>
	<input type="hidden" id="patternPropId" name="patternPropId" value="" />
	<input name="patternId" id="patternId" type="hidden" class="itext" />
	<input name="oper" id="oper" type="hidden" class="itext" value="temp" />
	<textarea id="patternXml" name="patternXml" style="visibility: hidden"></textarea>
</div>
<div><input type="hidden" id="patternId" name="patternId"></div>
<div><input type="hidden" id="paterName" name="patternName"></div>
<div><input type="hidden" id="featureName" name="txnparamName"></div>
<div><input type="hidden" id="txnparamId" name="txnparamId"></div>
</form>

</body>
</html>
