<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>#springMessage("view.tms.dp.pattern.attr.list.title")</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.url.js"></script>
<script type="text/javascript">
var g = "";
$(document).ready(function(){
	//加载信息
	var patternId = jQuery.url.param("patternId");
	$('#patternId').val(patternId);
	//组装表格
	 g = $("#boxdiv").grid({
		title:'#springMessage("view.tms.dp.pattern.attr.list.title")'+ "<div  style=\"display: inline\" id='addTitle'></div>",
		columns:[
			{name:'#springMessage("view.tms.dp.pattern.attr.txnfid")', width: 80, dataIndex:'TXNPARAMNAME'},
			{name:'#springMessage("view.tms.dp.pattern.attr.store")', width: 20, dataIndex:'STORECOLUMN'},
			{name:'#springMessage("view.tms.pub.crdate")', width: 40, dataIndex:'CREATETIME'},
			{name:'#springMessage("view.tms.pub.update")', width: 40, dataIndex:'MODIFYTIME'}
		],
		ds:{
			url:"/tms/dp/pattern/attr/list",
				params:{patternId:''+patternId,
						oper:'temp'}
		},
		toolbar:[
			{id:"btn-find", icon:"icon-tb-find", text:'#springMessage("view.tms.pub.btn.find")', toggleQform:true},
			{id:"btn-add", icon:"icon-tb-add", text:'#springMessage("view.tms.pub.btn.new")'},
			{id:"btn-edit", icon:"icon-tb-edit", text:'#springMessage("view.tms.pub.btn.edit")'},
			{id:"btn-del", icon:"icon-tb-del", text:'#springMessage("view.tms.pub.btn.del")'},
			{id:"btn-back", icon:"icon-tb-aw-l", text:'#springMessage("view.tms.pub.btn.banck")'}
		],
		pagebar: true,
		qform: {id:"qform", display:false}

	});
	g.goPage();
	
	//设置行为模式名称
	jcl.postJSON('/tms/dp/pattern/get', 'patternId='+patternId+'&oper=temp', function(data){
			$('#addTitle').html("--" + data.row["PATTERNNAME"]); 
	});
	
	$("#btn-back").click(function(){
		jcl.go('/tms/dp/pattern/list');
	});
	
	$("#quick_search_btn").click(function(){
		var params = $('#qform').serialize();
		g.setDsParams(params);
		g.goPage();
	});
	$("#btn-add").click(function(){
		jcl.go('/tms/dp/pattern/attr/add?' + "patternId=" + patternId);
	});
	
	$("#btn-edit").click(function(){
		var rows = g.selectedRows();
		if(rows.length == 0){ 
			alert('#springMessage("view.tms.pub.checkbox.msg0")!');
			return;
		}
		if(rows.length>1){
			alert('#springMessage("view.tms.pub.checkbox.msg1")!');
			return;
		}
		var patternPropId = [];
		$.each(rows, function(i,row){
			patternPropId.push('patternPropId='+row['PATTERNPROPID']);
		});                  
		jcl.go('/tms/dp/pattern/attr/editTemp?'+patternPropId[0]+"&patternId=" + patternId);
	});
	
	$("#btn-del").click(function(){
		//TODO: 安全起见，应逐条删除
		var rows = g.selectedRows();
		if(rows.length == 0){ 
			alert('#springMessage("view.tms.pub.checkbox.msg0")!');
			return;
		}
		/*if(rows.length>1){
			alert("只能选中一条记录");
			return;
		}*/
		if(confirm("确定删除行为模式属性信息？")){
			var patternPropId = [];
			$.each(rows, function(i, row){
				patternPropId.push('patternPropId='+row['PATTERNPROPID']);
			});
			var params = patternPropId.join('&');
			params += "&patternId=" + patternId;
			jcl.postJSON('/tms/dp/pattern/attr/del', params, function(data){
				alert('删除成功!');
				g.goPage();
			});
		}else{
			return ;
		}
	});
	//交易属性
	var param = 'patternId='+patternId+'&oper=temp';
	jcl.postJSON('/tms/dp/pattern/attr/listFeats', param, function(data){
			$.each(data.row, function(i,row){
				if(row['TXNFEATUREID']==null || row['TXNFEATUREID']=="" || row['TXNFEATUREID']=="null" ){//如果是组或渠道，添加为optgroup属性，不能选择               
					$("select[name=FLAG]").append("<optgroup label='"+row['PROPNAME']+"'> "+ row['PROPNAME'] + "</optgroup>");
				}else{
					$("select[name=FLAG]").append("<option datatype='" + row['DATATYPE'] + "' value='" + row['TXNFEATUREID'] + "'>" + row['PROPNAME'] + "</option>");
				}
				//$("select[name=FLAG]").append("<option datatype='" + row['DATATYPE'] + "' value='" + row['TXNFEATUREID'] + "'>" + row['PROPNAME'] + "</option>");  
			}); 
	});
});
</script>

</head>
<body>

<div id="boxdiv" class="box"></div>

<form id="qform" name="qform">
<input style="display:none" />
 <input name="patternId" id="patternId" type="hidden" value=""/>
 <input name="oper" id="oper" type="hidden" class="itext" value="temp" />
 <input name="txnparamName" id="patternPropName" type="hidden"  />
  <input name="patternPropId" id="patternPropId" type="hidden"  />
   <table>
       <tr>
           <td width="80">交易属性</td>
           <td width="215">
              <select id="FLAG" name="FLAG">
                     <option value="">--请选择--</option>
               </select>
           </td>
           <td width="60">&nbsp;</td>
           <td width="215">&nbsp;</td>
           <td  align="center"><input style="visibility: " id="quick_search_btn" type="button" value="快速查询" class="btn"/></td>
       </tr>
       
	</table>
</form>

</body>
</html>
