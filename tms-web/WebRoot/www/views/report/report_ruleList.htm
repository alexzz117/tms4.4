<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>#springMessage("view.report.rule.list.title")</title>
<link href="$rc.contextPath/s/common/css/page.css" rel="stylesheet" type="text/css" />
<link href="$rc.contextPath/s/common/css/tree.css" rel="stylesheet" type="text/css" />
<!-- <script type="text/javascript" src="$rc.contextPath/s/common/js/jquery.min.js"></script> -->
<script type="text/javascript" src="$rc.contextPath/s/report/echarts/jquery.min.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/report/echarts/echarts.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/browser.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/js/jcl.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/tms35/js/commoncheck.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/env.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/common/env/message.js"></script>
<!-- <script type="text/javascript" src="$rc.contextPath/s/report/js/FusionCharts/FusionCharts.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/report/js/FusionMaps/FusionMaps.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/report/js/FusionWidgets/FusionCharts.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/report/js/PowerCharts/FusionCharts.js"></script> -->
<script type="text/javascript" src="$rc.contextPath/s/tms35/js/query/jcq.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/report/js/reportPrint.js"></script>
<script type="text/javascript" src="$rc.contextPath/s/report/js/reportEcharts.js"></script>
<style type="text/css">
.chartsDiv{
	height:300px;
	width:98%;
	border:0.5px solid;
	/*display:none; */
}
</style>
<script type="text/javascript">
var myChart;
var echarts;
$(document).ready(function(){
	initParams();
	qBox = new jcl.ui.Box({
		title:'#springMessage("view.report.rule.form.title")'
	});
	qBox.title.css({cursor: 'pointer'});
	qBox.container.parent().parent().css({borderBottomWidth:0});
	displayBoxContent(qBox.title, qBox.container);
	qBox.title.click();

	qForm = new jcl.ui.Form({
		display: true,
		layout: 'list',
		items:[
			{label:'#springMessage("view.report.pub.form.txnName")',name:'txnIds',  type:'treeselector',rtNode:true, multiple:true, cascadeCheck:true, ds:{type:'remote', url:'/tms35/trandef/query', parser:{key:'list', text:'TAB_DESC', value:'TAB_NAME'}, lazyLoad:true}},
			{label:'#springMessage("view.report.rule.list.ruleName")',name:'ruleName',  type:'text'},
			{label:'#springMessage("view.report.pub.form.reporttype")',name:'reporttype',  type:'selector', items:[{text:'日报', value:'dayreport'}, {text:'月报', value:'monthreport'}, {text:'年报', value:'yearreport'}]},
			{label: '#springMessage("view.report.pub.form.date")',type: 'dateduration', duraSeparator:' ', viewSeparator:'至', layout:'date', items:[{name:'startTime'},{name:'endTime'}]}
		],
		btns:[
			{id: 'quick_search_btn', text: '#springMessage("view.cmc.but.find")'}
		]
	}, qBox.container);
	qForm.getItem(3).val(['', date]);
	
	chartBox = new jcl.ui.Box({
		title:'#springMessage("view.report.rule.shape.title")',
		marginTop:0
	});
	chartBox.title.css({cursor: 'pointer'});
	chartBox.container.parent().parent().css({borderBottomWidth:0});
	displayBoxContent(chartBox.title, chartBox.container);
	
	chartForm = new jcl.ui.Form({
		display: true,
		items:[
			{label:'#springMessage("view.report.pub.shape.target")', name:'target', type:'selector', items:[
				{text:'交易执行次数', value:'TRIGGERNUM'},
				{text:'规则命中数', value:'HITNUM'},
				{text:'规则命中率', value:'HITRATE'},
				// {text:'平均运行计算时间', value:'AVGTIME'},
				// {text:'最大运行时间', value:'MAXTIME'},
				// {text:'最小运行时间', value:'MINTIME'},
				{text:'交易执行占比', value:'TRIGGERRATE'},
				{text:'命中占比', value:'HITNUMRATE'}
			]},
			// {label:'#springMessage("view.report.pub.shape.shape")', name:'shape', type:'selector', items:[
			// 	{text:'柱形图', value:'ColumShape'},
			// 	{text:'饼形图', value:'PieShape'}
			// ]},
			{label:'#springMessage("view.report.pub.shape.tops")', name:'tops', type:'selector', items:[
				{text:'前5名', value:'5'},
				{text:'前10名', value:'10', selected:true},
				{text:'前20名', value:'20'},
				{text:'前30名', value:'30'}
			]}
		]
	}, chartBox.container);
	chartBox.addDom($('#chartdiv'));
	
	//组装表格
	ruleGrid = new jcl.ui.Grid({
		title:'#springMessage("view.report.rule.list.title")',
		marginTop:0,
		//width:1100,
		table:{
			checkboxEnable:false,
			columns:[
				{name:'#springMessage("view.report.rule.list.ruleName")', width: 80, dataIndex:'RULENAME'},
				{name:'#springMessage("view.report.rule.list.txnName")', width: 80, dataIndex:'TXNNAME'},
				// {name:'#springMessage("view.report.rule.list.score")', width: 30, dataIndex:'SCORE'},
				{name:'#springMessage("view.report.rule.list.txnNum")', width: 45, dataIndex:'TRIGGERNUM'},
				{name:'#springMessage("view.report.rule.list.hitNum")', width: 45, dataIndex:'HITNUM'},
				{name:'#springMessage("view.report.rule.list.hitRate")', width: 45, dataIndex:'HITRATE'},
				// {name:'#springMessage("view.report.rule.list.avgTime")', width: 45, dataIndex:'AVGTIME'},
				// {name:'#springMessage("view.report.rule.list.maxTime")', width: 45, dataIndex:'MAXTIME'},
				// {name:'#springMessage("view.report.rule.list.minTime")', width: 45, dataIndex:'MINTIME'},
				{name:'#springMessage("view.report.rule.list.txnrate")', width: 50, dataIndex:'TRIGGERRATE'},
				{name:'命中占比', width: 50, dataIndex:'HITNUMRATE'}
			],
			ds:{
				url:"/report/rule/list",
				callback:function(list){
					for(var i = 0; i < list.length; i++){
						//ms
						// list[i]['AVGTIME'] = list[i]['AVGTIME'] + 'ms' ;
						// list[i]['MAXTIME'] = list[i]['MAXTIME'] + 'ms' ;
						// list[i]['MINTIME'] = list[i]['MINTIME'] + 'ms' ;
						//%
						list[i]['HITRATE'] = list[i]['HITRATE'] + '%' ;
						list[i]['TRIGGERRATE'] = list[i]['TRIGGERRATE'] + '%' ;
						list[i]['HITNUMRATE'] = list[i]['HITNUMRATE'] + '%' ;
					}
				}
			},
			pagebar: false
		},
		toolbar:[
			{id:"btn-export", icon:"icon-tb-edit", text:'#springMessage("view.report.pub.list.export")'},
			{id:"btn-print", icon:"icon-tb-edit", text:'#springMessage("view.tms.pub.btn.print")'}
		]
	});
	
	chartForm.getItem('target').component.onChange(function(){
		changeTarget();
	});
	// chartForm.getItem('shape').component.onChange(function(){
	// 	changeTarget();
	// });
	chartForm.getItem('tops').component.onChange(function(){
		changeTarget();
	});
	//快速查询
	$("#quick_search_btn").click(function(){
		var ruleName = qForm.getItem('ruleName').val();
		if(ruleName!='' && !checkSpecialCharacterInTxn('#springMessage("view.tms.monitor.center.rulename")', ruleName, 2)){
	    	return false;
	    }
		var reporttype = qForm.getItem('reporttype').val();
		if(reporttype == 'dayreport'){
			var dayTimes = qForm.getItem(3).val();
			var days = dayTimes.split("\,");
			if((days[0]!=''&&days[1]!='')&&(days[0]>days[1])){
				alert('#springMessage("view.tms.pub.datecheck")');
				return ;
			}
		}
		searchData(ruleGrid);
	});
	
	//导出列表信息
	$("#btn-export").click(exportList);
	//打印
	$("#btn-print").click(toprint);
	
	qForm.getItem('reporttype').component.onChange(function(_this){
		var selectedValue = _this.value;
		var item = {};
	    switch(selectedValue){  		
		    case "dayreport":
		    	item = {type:'dateduration', layout:'date', items:[{name:'startTime'},{name:'endTime', value:date}]};
			    break;  		
		    case "monthreport":
				var _items = [];
				var currMonth = toperate_year+''+toperate_month;
				for(var i=1;i<=(toperate_month*1);i++){
					var month = toperate_year+''+(i>9?i:'0'+i);
					_items.push({text:toperate_year+'-'+(i>9?i:'0'+i), value:month, selected:(month == currMonth)});
				}
				item = {name:'monthDate', type:'selector', items:_items};
			    break;
		    case "yearreport":
		    	var _items = [];
		    	for (var j = 2010; j<= (toperate_year*1); j++){
		    		_items.push({text:j, value:j, selected:(toperate_year == j)});
				}
		    	item = {name:'yearDate', type:'selector', items:_items};
			    break;
	    }
	    qForm.setItem(item, 3);
	});
	searchData(ruleGrid);
});

//绘制展示图形
function createShape(list){
	if (!myChart) {
		if (echarts) {
			myChart = echarts.init(document.getElementById('chartdiv'));
			window.onresize = myChart.resize;
			setChart(list);
			return;
		};
		// 按需加载
		require.config({
		    paths: {
		        echarts: '$rc.contextPath/s/report/echarts'
		    }
		});
		require(
		        [
		            'echarts',
		            'echarts/chart/bar',
		            'echarts/chart/pie',
		            'echarts/chart/funnel',
		            'echarts/chart/line',
		            'echarts/chart/map'
		        ],
		   function(ec){
		   		echarts = ec;
		    	myChart = ec.init(document.getElementById('chartdiv'));
		    	window.onresize = myChart.resize;
		    	setChart(list);
		   }
		); 
	}else{
		setChart(list);
	}
}
//更改展示图形监控指标
function changeTarget(){
	var qParam = qForm.serialize();
	var cParam = chartForm.serialize();
	var params = [qParam, cParam].join('&');
	ruleGrid.setDsParams(params);
	ruleGrid.goPage();
	jcl.postJSON('/report/rule/showChart', params, function(data){
		createShape(data);
	});
}
function setChart(list){
		myChart.showLoading({
		    text: '正在努力的读取数据中...'    //loading话术
		});
		var option = getOptionV(list);
		myChart.hideLoading();
		myChart.clear();
		myChart.setOption(option);
		myChart.refresh;
		myChart.resize;
		myChart.restore;
}
function getOptionV(data){
	// var cf_txn = chartForm.getItem('txn').val();
	// var cf_txn_t = chartForm.getItem('txn').getText();
	var cf_target = chartForm.getItem('target').val();
	var cf_target_t = chartForm.getItem('target').getText();
	// var cf_tops = chartForm.getItem('tops').val();
	// alert(cf_txn_t);
	// var g_list = txnGrid.table.page.list;
	var g_list = data.CHARTDATA;
	// if(g_list.length > 0 && cf_target!='' && cf_txn_t != '')
	// if(g_list.length > 0 && cf_target!='' && cf_txn_t != '')
	// {
			
	// }else{
	// 	return '';
	// }
 	var op_legend_data = [];//显示数据类型
 	op_legend_data.push(cf_target_t);
 	var op_x_data = [];  //xAxis显示列
 	var op_series = [];  //数据
 // 	var cf_txn_arr = cf_txn.split(',');//交易ID数组
 // 	var op_x_data = cf_txn_t.split(',');
 // 	var cf_target_t_arr = cf_target_t.split(',');
 // 	var cf_target_arr = cf_target.split(',');
 //  	for (var i = 0; i < cf_target_t_arr.length; i++) {
 //  		op_legend_data.push(cf_target_t_arr[i]+'-欺诈数');
 //  		op_legend_data.push(cf_target_t_arr[i]+'-非欺诈数');
 //  		op_series.push(
 //  			{ name:cf_target_t_arr[i]+'-欺诈数',
 //  			ps:cf_target_arr[i]+'_FRAUDNUMBER',
 //  			itemStyle : { normal: {label : {show: true, position: 'insideRight'}}},
 //            type:'bar',
 //            stack: '处置',
 //            data:[]
 //  			}
 //  		);
 //  		op_series.push(
 //  			{ name:cf_target_t_arr[i]+'-非欺诈数',
 //  			ps:cf_target_arr[i]+'_NONFRAUDNUMBER',
 //  			itemStyle : { normal: {label : {show: true, position: 'insideRight'}}},
 //            type:'bar',
 //            stack: '处置',
 //            data:[]
 //  			}
 //  		);
	// }
	var g_index = 1;
	var op_series_data = [];
  	for(var i = 0; i < g_list.length; i++){
  		var key =  g_list[i]['RULENAME'] +'['+ g_list[i]['TXNNAME']+']';
  		if ((g_index)%2 == 0) {
	  			op_x_data.push('\n'+key);
	  		}else{
	  			op_x_data.push(key);
	  		}
  		op_series_data.push(g_list[i][cf_target]);
  		g_index++;
  		//alert(cf_txn_arr.indexOf(g_list[i]['TXNID']));
  		// if(cf_txn_arr.indexOf(g_list[i]['TXNID']) > -1){
  		// 	for(var j = 0; j < op_series.length; j++){
  		// 		var list_v = g_list[i][op_series[j].ps];
  		// 		//alert(op_series[j].ps+'--'+list_v);
  		// 		if(list_v != null){
  		// 			op_series[j].data.push(list_v);
  		// 		}
  		// 	}
  		// }
  	}
  	op_series.push(
  			{ name:cf_target_t,
  			// ps:cf_target_arr[i]+'_NONFRAUDNUMBER',
  			itemStyle : { normal: {label : {show: true, position: 'insideRight'}}},
            type:'bar',
            // stack: '处置',
            data:op_series_data
  			}
  		);

  	var option = {};
	option.op_legend_data = op_legend_data;
	option.op_x_data = op_x_data;
	option.op_series = op_series;
	option.chartID = 'chartdiv';
	option.magicType = ['line', 'bar'];
	option.xAxis = [
		        {
		            type : 'category',
		            axisLabel:{
                    	interval:0, //全部显示
                    	// textStyle:{
                     //   	 color: '#fff'    
                    	// },
			            formatter: function (params) {
			            	var res = params;
			            	var index = params.indexOf('[');
			            	if (index != -1) {
			            		res = res.substring(0,index);
			            	}
				            return res;
			        	}
                	},
		            data : op_x_data
		        }
		    ];
	return GenOption(option);
}
//根据输入的查询信息和图形展示区的设置，查询交易告警信息数据
function searchData(g){
	var qParam = qForm.serialize();
	var cParam = chartForm.serialize();
	var params = [qParam, cParam].join('&');
	g.setDsParams(params);
	g.goPage();
	jcl.postJSON('/report/rule/showChart', params, function(data){
		createShape(data);		//创建图形
	});
}

//列表信息导出
function exportList(){
	var qParam = qForm.serialize();
	var cParam = chartForm.serialize();
	var params = [qParam, cParam].join('&');
	window.open(jcl.env.contextPath+"/report/rule/export?"+params);
}

function toprint(){
	reportPrint({rGrid:ruleGrid, width:ruleGrid.jqDom.width()});
}

//隐藏/展开相应的层
function displayBoxContent(trigger, content){
	trigger.on('click', function(){
		if(content.is(':hidden')){
			content.parent().show();
		}else{
			content.parent().hide();
		}
	})
}

//初始化时间，当前时间的前一天
function initParams(){
	var nowDate = new Date();
	var operate_Date = new Date(nowDate.getTime() - 24*60*60000);
	//月报及年报 获取 当天的月份及年
	toperate_year = nowDate.getFullYear();
	toperate_month = nowDate.getMonth()+1;
	
	operate_year = operate_Date.getFullYear();
	operate_month = operate_Date.getMonth()+1;//获取本月
	
	var operate_day = operate_Date.getDate();
	var operate_hour = operate_Date.getHours();
	var operate_minutes = operate_Date.getMinutes();
	var operate_second = operate_Date.getSeconds();
	
	if(toperate_month < 10) toperate_month = "0" + toperate_month;
	if(operate_month < 10) operate_month = "0" + operate_month;
	if(operate_day < 10) operate_day = "0" + operate_day;
	if(operate_hour < 10) operate_hour = "0" + operate_hour;
	if(operate_minutes < 10) operate_minutes = "0" + operate_minutes;
	if(operate_second < 10) operate_second = "0" + operate_second;
	date = operate_year+"-"+operate_month+"-"+operate_day;
}
</script>

</head>
<body>
<div id="chartdiv" class="chartsDiv" align="center"></div>
<!-- <table width="98%" border="0" cellspacing="0" cellpadding="0" align="center">
	<tr><td>
		<div class="box-title-wrap-m" style="width: 100%;">
			<div class="box-title-wrap-l">
				<div class="box-title-wrap-r">
					<div class="box-title" onclick="displayDiv('queryForm')" style="cursor: pointer;">#springMessage("view.report.rule.form.title")</div>
				</div>
			</div>
		</div>
		<div id="queryForm" style="display: none;"></div>
	</td></tr>
	
	<tr><td id="chartTd">
		<div class="box-title-wrap-m" style="width: 100%;">
			<div class="box-title-wrap-l">
				<div class="box-title-wrap-r">
					<div class="box-title" onclick="displayDiv('chartShapediv')" style="cursor: pointer;">#springMessage("view.report.rule.shape.title")</div>
				</div>
			</div>
		</div>
		<div class="box-qform-wrap-b" id="chartShapediv" style="width: 100%;">
			<div class="box-qform-wrap-t">
				<div id="condetiondiv" class="box-qform"></div>
				<div id="chartdiv" class="box-qform" align="center"></div>
			</div>
		</div>
	</td></tr>
	
	<tr><td>
		<div id="listdiv" class="box" ></div>
	</td></tr>
</table> -->
</body>
</html>


